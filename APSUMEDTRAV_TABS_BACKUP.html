<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APSUMEDTRAV - Fiche d'Aptitude M√©dicale au Travail</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='50' font-size='50'>üè•</text></svg>">
    
    <!-- ============================================ -->
    <!-- BIBLIOTH√àQUES EXTERNES (ordre important) -->
    <!-- ============================================ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <!-- üî• NOUVEAU : Firebase Auth pour identifier les intervenants -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ============================================ */
        /* STYLES CSS (inchang√©s + ajouts) */
        /* ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            font-weight: 500;
        }

        .tabs-wrapper {
            background: #f8f9fa;
            padding: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 10px;
        }

        .tab {
            background: white;
            border: 2px solid #dee2e6;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #495057;
        }

        .tab:hover {
            background: #f1f3f5;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .action-bar-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #dee2e6;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .action-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .info-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #e7f3ff;
            color: #0066cc;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }

        .required {
            color: #dc3545;
        }

        .anciennete-display {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            color: #0066cc;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
                border-radius: 0;
            }

            .tabs-wrapper,
            .action-bar-fixed {
                display: none;
            }

            .tab-content {
                display: block !important;
                page-break-after: always;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-bar-content {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }

        /* STYLES POUR L'IMPRESSION */
        @media print {
            body > *:not(#panel-historique) {
                display: none !important;
            }
            #panel-historique {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                overflow: visible !important;
            }
            #contenu-historique {
                background: white !important;
                max-height: none !important;
                overflow: visible !important;
            }
            #panel-historique button {
                display: none !important;
            }
            #panel-historique .btn-fermer {
                display: none !important;
            }
            * {
                background: white !important;
                color: black !important;
            }
            [style*="background: #d4edda"] {
                background: #d4edda !important;
                border-color: #28a745 !important;
            }
            [style*="background: #f8d7da"] {
                background: #f8d7da !important;
                border-color: #dc3545 !important;
            }
            [style*="background: #fff3cd"] {
                background: #fff3cd !important;
                border-color: #ffc107 !important;
            }
        }

        /* üî• NOUVEAU : Styles pour le panneau de connexion */
        #loginOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 999999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #loginBox {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        #loginBox h2 {
            border: none;
            margin-bottom: 10px;
        }
        #loginBox input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
        }
        #loginBox input:focus {
            outline: none;
            border-color: #667eea;
        }
        #loginBox button {
            width: 100%;
            padding: 14px;
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        #loginError {
            color: #dc3545;
            font-size: 13px;
            margin-top: 10px;
            min-height: 20px;
        }
        /* üî• NOUVEAU : Barre utilisateur connect√© */
        #userBar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 20px;
            z-index: 10001;
            display: none;
            font-size: 13px;
        }
        #userBar .user-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* üî• NOUVEAU : Indicateur de sync */
        #syncIndicator {
            position: fixed;
            top: 40px;
            right: 20px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10002;
            transition: all 0.3s;
        }
        .sync-ok { background: #d4edda; color: #155724; }
        .sync-loading { background: #fff3cd; color: #856404; }
        .sync-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<!-- üî• NOUVEAU : √âcran de connexion -->
<div id="loginOverlay">
    <div id="loginBox">
        <div style="font-size: 60px; margin-bottom: 15px;">üè•</div>
        <h2 style="color: #667eea;">APSUMEDTRAV</h2>
        <p style="color: #6c757d; margin-bottom: 25px;">Connectez-vous pour acc√©der √† l'application</p>
        
        <input type="email" id="loginEmail" placeholder="üìß Adresse email" autocomplete="email">
        <input type="password" id="loginPassword" placeholder="üîí Mot de passe" autocomplete="current-password">
        
        <button onclick="connexion()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            üîë Se connecter
        </button>
        <button onclick="inscription()" style="background: #28a745; color: white;">
            üìù Cr√©er un compte
        </button>
        
        <div id="loginError"></div>
        
        <p style="margin-top: 20px; font-size: 12px; color: #adb5bd;">
            Chaque intervenant doit avoir son propre compte.<br>
            Les donn√©es sont partag√©es entre tous les utilisateurs.
        </p>
    </div>
</div>

<!-- üî• NOUVEAU : Barre utilisateur -->
<div id="userBar">
    <div class="user-bar-content">
        <span>üë®‚Äç‚öïÔ∏è Connect√© : <strong id="userEmail">-</strong> | <span id="userName">-</span></span>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="syncIndicator" class="sync-ok">üü¢ Synchronis√©</span>
            <button onclick="deconnexion()" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                üö™ D√©connexion
            </button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- PANNEAU DE RECHERCHE ET HISTORIQUE -->
<!-- ============================================ -->
<div id="searchHistoryPanel" style="
    max-width: 1200px;
    margin: 20px auto;
    margin-top: 50px;
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 2px solid #667eea;
    display: none;
">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #667eea; display: flex; align-items: center; gap: 10px;">
            üîç Gestion des Patients - Base de Donn√©es
        </h2>
        <button onclick="cacherPanneau()" style="
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        ">‚úï Masquer</button>
    </div>
    
    <!-- Statistiques -->
    <div style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    ">
        <div style="background: #e8f4ff; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #007bff;">
                <span id="totalPatients">0</span>
            </div>
            <div style="color: #666; font-size: 12px;">Total Patients</div>
        </div>
        <div style="background: #e8ffe8; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                <span id="patientsToday">0</span>
            </div>
            <div style="color: #666; font-size: 12px;">Aujourd'hui</div>
        </div>
        <div style="background: #fff3e8; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #ff9800;">
                <span id="patientsWeek">0</span>
            </div>
            <div style="color: #666; font-size: 12px;">Cette semaine</div>
        </div>
        <div style="background: #f3e8ff; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">
                <span id="patientsMonth">0</span>
            </div>
            <div style="color: #666; font-size: 12px;">Ce mois</div>
        </div>
    </div>
    
    <!-- Barre de recherche et actions -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <input type="text" id="searchPatientInput" placeholder="üîé Rechercher par nom, pr√©nom, entreprise..." 
            style="
                flex: 1;
                min-width: 250px;
                padding: 12px;
                border: 2px solid #dee2e6;
                border-radius: 8px;
                font-size: 14px;
            "
            onkeyup="rechercherPatientLive()"
        >
        
        <button onclick="actualiserDepuisFirestore()" 
                style="padding: 12px 20px; background: #28a745; color: white; border: none; 
                       border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
                       transition: all 0.2s; box-shadow: 0 2px 5px rgba(40,167,69,0.3);"
                onmouseover="this.style.transform='translateY(-2px)'"
                onmouseout="this.style.transform='translateY(0)'">
            üîÑ Actualiser
        </button>
        
        <!-- Menu d√©roulant EXPORTS -->
        <div style="position: relative; display: inline-block;">
            <button onclick="toggleMenuExports()" 
                    style="padding: 12px 20px; background: #667eea; color: white; border: none; 
                           border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
                           display: flex; align-items: center; gap: 8px; transition: all 0.2s;
                           box-shadow: 0 2px 5px rgba(102,126,234,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'">
                üìä Exports <span style="font-size: 10px;">‚ñº</span>
            </button>
            
            <div id="menuExports" style="
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 2px solid #667eea;
                border-radius: 8px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 250px;
                margin-top: 8px;
            ">
                <button onclick="exporterCSVComplet(); toggleMenuExports()" 
                        style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; 
                               cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; 
                               align-items: center; gap: 10px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                    <span style="font-size: 18px;">üìä</span> CSV Complet
                </button>
                <button onclick="exporterToutesConsultationsPDFAvecFiltres(); toggleMenuExports()" 
                        style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; 
                               cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; 
                               align-items: center; gap: 10px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                    <span style="font-size: 18px;">üìÑ</span> PDF Global
                </button>
                <button onclick="exporterStatistiquesPDF(); toggleMenuExports()" 
                        style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; 
                               cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; 
                               align-items: center; gap: 10px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                    <span style="font-size: 18px;">üìà</span> Statistiques Globales
                </button>
                <!-- BOUTON EXPORT EXCEL INDIVIDUEL -->
<button onclick="exporterRapportExcel(); toggleMenuExports()"
    style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; display: flex;
           cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee;
           align-items: center; gap: 10px; transition: all 0.2s;"
    onmouseover="this.style.background='#e8f5e9'"
    onmouseout="this.style.background='white'">
    <span style="font-size: 18px;">üìó</span> Excel Individuel
</button>
                <button onclick="exporterConsultationsFiltrees(); toggleMenuExports()" 
                        style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; 
                               cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; 
                               align-items: center; gap: 10px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                    <span style="font-size: 18px;">üìÖ</span> Export par P√©riode
                </button>
                <button onclick="exporterPDFProtege(); toggleMenuExports()" 
                        style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; 
                               cursor: pointer; font-size: 14px; border-radius: 0 0 8px 8px; display: flex; 
                               align-items: center; gap: 10px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                    <span style="font-size: 18px;">üîí</span> Export Prot√©g√©
                </button>
            </div>
        </div>
    </div>
    
    <!-- Tableau des r√©sultats -->
    <div id="resultatsRecherche" style="
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        background: #f8f9fa;
    ">
        <p style="text-align: center; color: #666;">Chargement des donn√©es...</p>
    </div>
</div>

<!-- Bouton flottant pour ouvrir le panneau -->
<button id="btnOpenSearch" onclick="afficherPanneau()" style="
    position: fixed;
    top: 50px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 1000;
    display: block;
">üîç</button>

<!-- ============================================ -->
<!-- PANNEAU HISTORIQUE INDIVIDUEL -->
<!-- ============================================ -->
<div id="panel-historique" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100000;
    display: none;
    overflow-y: auto;
    padding: 20px;
">
    <div style="
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        padding: 30px;
        position: relative;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    ">
        <button onclick="fermerHistorique()" style="
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
            transition: all 0.3s;
        " onmouseover="this.style.background='#c82333'; this.style.transform='rotate(90deg)'"
           onmouseout="this.style.background='#dc3545'; this.style.transform='rotate(0)'">√ó</button>
        
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 25px; margin: -30px -30px 25px -30px; border-radius: 15px 15px 0 0;">
            <h2 style="color: white; margin: 0; font-size: 26px; font-weight: 700;">
                üìã Historique des Consultations
            </h2>
            <p id="info-travailleur" style="color: white; margin: 10px 0 0 0; opacity: 0.95; font-size: 15px;">
                Chargement...
            </p>
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
            <button onclick="exporterHistoriqueIndividuelPDF()" style="
                padding: 12px 25px;
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white; border: none; border-radius: 8px; cursor: pointer;
                font-weight: 600; font-size: 15px;
                box-shadow: 0 4px 15px rgba(220,53,69,0.3); transition: all 0.3s;
                display: flex; align-items: center; gap: 8px;
            " onmouseover="this.style.transform='translateY(-2px)'"
               onmouseout="this.style.transform='translateY(0)'">
                üìÑ Exporter PDF Complet
            </button>
            <button onclick="exporterHistoriqueCSV()" style="
                padding: 12px 25px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white; border: none; border-radius: 8px; cursor: pointer;
                font-weight: 600; font-size: 15px;
                box-shadow: 0 4px 15px rgba(40,167,69,0.3); transition: all 0.3s;
                display: flex; align-items: center; gap: 8px;
            " onmouseover="this.style.transform='translateY(-2px)'"
               onmouseout="this.style.transform='translateY(0)'">
                üìä Exporter CSV
            </button>
            <button onclick="imprimerHistorique()" style="
                padding: 12px 25px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; border: none; border-radius: 8px; cursor: pointer;
                font-weight: 600; font-size: 15px;
                box-shadow: 0 4px 15px rgba(102,126,234,0.3); transition: all 0.3s;
                display: flex; align-items: center; gap: 8px;
            " onmouseover="this.style.transform='translateY(-2px)'"
               onmouseout="this.style.transform='translateY(0)'">
                üñ®Ô∏è Imprimer
            </button>
        </div>
        
        <div id="contenu-historique" style="
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            min-height: 300px;
        ">
            <p style="text-align: center; color: #6c757d; padding: 40px 0;">
                <span style="font-size: 50px; display: block; margin-bottom: 15px;">‚è≥</span>
                Chargement de l'historique...
            </p>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- CONTENEUR PRINCIPAL DU FORMULAIRE -->
<!-- ============================================ -->
<div class="main-container" style="margin-top: 40px;">
    <div class="header">
        <h1>üè• APSUMEDTRAV</h1>
        <p>Fiche d'Aptitude M√©dicale au Travail</p>
    </div>

    <div class="tabs-wrapper">
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'identification')">üìã Identification</button>
            <button class="tab" onclick="openTab(event, 'antecedents')">üìÅ Ant√©c√©dents</button>
            <button class="tab" onclick="openTab(event, 'clinique')">ü©∫ Examen Clinique</button>
            <button class="tab" onclick="openTab(event, 'paraclinique')">üî¨ Examens Paracliniques</button>
            <button class="tab" onclick="openTab(event, 'vaccinations')">üíâ Vaccinations</button>
            <button class="tab" onclick="openTab(event, 'risques')">‚ö†Ô∏è Risques Pro</button>
            <button class="tab" onclick="openTab(event, 'conclusion')">‚úÖ Conclusion</button>
        </div>
    </div>

    <!-- ONGLET 1: IDENTIFICATION -->
    <div id="identification" class="tab-content active">
        <h2>üìã Identification du Travailleur</h2>
        <div class="form-section">
            <h3>Informations Personnelles</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="nom-cabinet">Nom du Cabinet M√©dical</label>
                    <input type="text" id="nom-cabinet" value="Cabinet M√©dical">
                </div>
                <div class="form-group">
                    <label for="date-naissance">Date de naissance <span class="required">*</span></label>
                    <input type="text" id="date-naissance" placeholder="JJ/MM/AAAA" required onchange="calculerAge()">
                </div>
                <div class="form-group">
                    <label for="nom">Nom <span class="required">*</span></label>
                    <input type="text" id="nom" required>
                </div>
                <div class="form-group">
                    <label for="prenom">Pr√©nom <span class="required">*</span></label>
                    <input type="text" id="prenom" required>
                </div>
                <div class="form-group">
                    <label for="age">√Çge</label>
                    <input type="text" id="age" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label for="date-consultation">Date de Consultation <span class="required">*</span></label>
                    <input type="text" id="date-consultation" placeholder="JJ/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label for="genre">Genre <span class="required">*</span></label>
                    <select id="genre" required>
                        <option value="">S√©lectionner</option>
                        <option value="homme">Homme</option>
                        <option value="femme">Femme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="telephone">T√©l√©phone</label>
                    <input type="tel" id="telephone">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Informations Professionnelles</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="matricule">Matricule</label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <input type="text" id="matricule" style="flex: 1;" placeholder="Saisir le matricule...">
                        <button type="button" onclick="ouvrirHistorique()" style="
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; border-radius: 8px; cursor: pointer;
                            font-weight: 600; white-space: nowrap;
                            box-shadow: 0 3px 10px rgba(102,126,234,0.3); transition: all 0.3s;
                            display: flex; align-items: center; gap: 6px;
                        " onmouseover="this.style.transform='translateY(-2px)'"
                           onmouseout="this.style.transform='translateY(0)'">
                            <span style="font-size: 16px;">üìã</span>
                            <span>Historique</span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="entreprise">Entreprise <span class="required">*</span></label>
                    <input type="text" id="entreprise" required>
                </div>
                <div class="form-group">
                    <label for="poste">Poste de travail <span class="required">*</span></label>
                    <input type="text" id="poste" required>
                </div>
                <div class="form-group">
                    <label for="departement">D√©partement/Service</label>
                    <input type="text" id="departement">
                </div>
                <div class="form-group">
                    <label for="date-embauche">Date d'embauche <span class="required">*</span></label>
                    <input type="text" id="date-embauche" placeholder="JJ/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label for="anciennete">Anciennet√©</label>
                    <div class="anciennete-display" id="anciennete">-- ans -- mois</div>
                </div>
                <div class="form-group">
                    <label for="type-contrat">Type de contrat</label>
                    <select id="type-contrat">
                        <option value="">S√©lectionner</option>
                        <option value="CDI">CDI</option>
                        <option value="CDD">CDD</option>
                        <option value="Int√©rim">Int√©rim</option>
                        <option value="Stage">Stage</option>
                        <option value="Alternance">Alternance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="horaire-travail">Horaire de travail</label>
                    <select id="horaire-travail">
                        <option value="">S√©lectionner</option>
                        <option value="jour">Travail de jour</option>
                        <option value="nuit">Travail de nuit</option>
                        <option value="poste">Travail post√©</option>
                        <option value="2x8">2x8</option>
                        <option value="3x8">3x8</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- ONGLET 2: ANT√âC√âDENTS -->
    <div id="antecedents" class="tab-content">
        <h2>üìÅ Ant√©c√©dents M√©dicaux</h2>
        <div class="form-section">
            <h3>Ant√©c√©dents Personnels</h3>
            <div class="form-group">
                <label>Ant√©c√©dents m√©dicaux</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="ant-med" value="diabete"> Diab√®te</label>
                    <label><input type="checkbox" name="ant-med" value="hta"> Hypertension</label>
                    <label><input type="checkbox" name="ant-med" value="asthme"> Asthme</label>
                    <label><input type="checkbox" name="ant-med" value="epilepsie"> √âpilepsie</label>
                    <label><input type="checkbox" name="ant-med" value="cardiaque"> Maladie cardiaque</label>
                    <label><input type="checkbox" name="ant-med" value="renale"> Maladie r√©nale</label>
                    <label><input type="checkbox" name="ant-med" value="hepatique"> Maladie h√©patique</label>
                    <label><input type="checkbox" name="ant-med" value="thyroide"> Thyro√Øde</label>
                </div>
            </div>
            <div class="form-group">
                <label for="autres-antecedents">Autres ant√©c√©dents (pr√©ciser)</label>
                <textarea id="autres-antecedents" rows="4"></textarea>
            </div>
        </div>
        <div class="form-section">
            <h3>Ant√©c√©dents Chirurgicaux</h3>
            <div class="form-group">
                <label for="chirurgie">Interventions chirurgicales ant√©rieures</label>
                <textarea id="chirurgie" rows="3" placeholder="Date et type d'intervention"></textarea>
            </div>
        </div>
        <div class="form-section">
            <h3>Ant√©c√©dents Professionnels</h3>
            <div class="form-group">
                <label for="accident-travail">Accidents de travail ant√©rieurs</label>
                <textarea id="accident-travail" rows="3" placeholder="Date, nature et s√©quelles √©ventuelles"></textarea>
            </div>
            <div class="form-group">
                <label for="maladie-pro">Maladies professionnelles</label>
                <textarea id="maladie-pro" rows="3"></textarea>
            </div>
        </div>
        <div class="form-section">
            <h3>Allergies et Intol√©rances</h3>
            <div class="form-group">
                <label for="allergies">Allergies connues</label>
                <textarea id="allergies" rows="3"></textarea>
            </div>
        </div>
        <div class="form-section">
            <h3>Habitudes de vie</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="tabac">Tabagisme</label>
                    <select id="tabac">
                        <option value="non">Non fumeur</option>
                        <option value="ancien">Ancien fumeur</option>
                        <option value="oui-occasionnel">Fumeur occasionnel</option>
                        <option value="oui-regulier">Fumeur r√©gulier</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nb-cigarettes">Si fumeur, nombre/jour</label>
                    <input type="number" id="nb-cigarettes" min="0">
                </div>
                <div class="form-group">
                    <label for="alcool">Consommation d'alcool</label>
                    <select id="alcool">
                        <option value="non">Non</option>
                        <option value="occasionnel">Occasionnelle</option>
                        <option value="moderee">Mod√©r√©e</option>
                        <option value="reguliere">R√©guli√®re</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="activite-physique">Activit√© physique</label>
                    <select id="activite-physique">
                        <option value="sedentaire">S√©dentaire</option>
                        <option value="legere">L√©g√®re</option>
                        <option value="moderee">Mod√©r√©e</option>
                        <option value="intense">Intense</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-section">
            <h3>Traitements en cours</h3>
            <div class="form-group">
                <label for="medicaments">M√©dicaments actuels</label>
                <textarea id="medicaments" rows="3" placeholder="Nom, dosage, fr√©quence"></textarea>
            </div>
        </div>
    </div>

    <!-- ONGLET 3: EXAMEN CLINIQUE -->
    <div id="clinique" class="tab-content">
        <h2>ü©∫ Examen Clinique</h2>
        <div class="form-section">
            <h3>Constantes Vitales</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="poids">Poids (kg)</label>
                    <input type="number" id="poids" step="0.1" min="0" oninput="calculerIMC()">
                </div>
                <div class="form-group">
                    <label for="taille">Taille (cm)</label>
                    <input type="number" id="taille" min="0" oninput="calculerIMC()">
                </div>
                <div class="form-group">
                    <label for="imc">IMC (calcul√©)</label>
                    <input type="text" id="imc" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label for="interpretation-imc">Interpr√©tation IMC</label>
                    <input type="text" id="interpretation-imc" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label for="ta-systolique">TA Systolique (mmHg)</label>
                    <input type="number" id="ta-systolique" min="0">
                </div>
                <div class="form-group">
                    <label for="ta-diastolique">TA Diastolique (mmHg)</label>
                    <input type="number" id="ta-diastolique" min="0">
                </div>
                <div class="form-group">
                    <label for="pouls">Pouls (/min)</label>
                    <input type="number" id="pouls" min="0">
                </div>
                <div class="form-group">
                    <label for="frequence-resp">Fr√©quence respiratoire (/min)</label>
                    <input type="number" id="frequence-resp" min="0">
                </div>
                <div class="form-group">
                    <label for="temperature">Temp√©rature (¬∞C)</label>
                    <input type="number" id="temperature" step="0.1" min="35" max="42">
                </div>
                <div class="form-group">
                    <label for="saturation">SpO2 (%)</label>
                    <input type="number" id="saturation" min="0" max="100">
                </div>
            </div>
        </div>
        <div class="form-section">
            <h3>Examen G√©n√©ral</h3>
            <div class="form-group">
                <label for="etat-general">√âtat g√©n√©ral</label>
                <select id="etat-general">
                    <option value="bon">Bon</option>
                    <option value="assez-bon">Assez bon</option>
                    <option value="altere">Alt√©r√©</option>
                </select>
            </div>
            <div class="form-group">
                <label for="observations-generales">Observations g√©n√©rales</label>
                <textarea id="observations-generales" rows="3"></textarea>
            </div>
        </div>
        <div class="form-section">
            <h3>Examen par Syst√®me</h3>
            <div class="form-group"><label for="examen-cardio">Examen cardiovasculaire</label><textarea id="examen-cardio" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-pulm">Examen pulmonaire</label><textarea id="examen-pulm" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-abdo">Examen abdominal</label><textarea id="examen-abdo" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-neuro">Examen neurologique</label><textarea id="examen-neuro" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-osteo">Examen ost√©o-articulaire</label><textarea id="examen-osteo" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-orl">Examen ORL</label><textarea id="examen-orl" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-ophtalmo">Examen ophtalmologique</label><textarea id="examen-ophtalmo" rows="3"></textarea></div>
            <div class="form-group"><label for="examen-dermato">Examen dermatologique</label><textarea id="examen-dermato" rows="3"></textarea></div>
        </div>
    </div>

    <!-- ONGLET 4: EXAMENS PARACLINIQUES -->
    <div id="paraclinique" class="tab-content">
        <h2>üî¨ Examens Paracliniques</h2>
        <div class="form-section">
            <h3>Biologie</h3>
            <div class="form-grid">
                <div class="form-group"><label for="date-bilan">Date du bilan</label><input type="text" id="date-bilan" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="glycemie">Glyc√©mie √† jeun (g/L)</label><input type="number" id="glycemie" step="0.01"></div>
                <div class="form-group"><label for="hba1c">HbA1c (%)</label><input type="number" id="hba1c" step="0.1"></div>
                <div class="form-group"><label for="cholesterol-total">Cholest√©rol total (mg/dL)</label><input type="number" id="cholesterol-total" step="0.01"></div>
                <div class="form-group"><label for="hdl">HDL (mg/dL)</label><input type="number" id="hdl" step="0.01"></div>
                <div class="form-group"><label for="ldl">LDL (mg/dL)</label><input type="number" id="ldl" step="0.01"></div>
                <div class="form-group"><label for="triglycerides">Triglyc√©rides (g/L)</label><input type="number" id="triglycerides" step="0.01"></div>
                <div class="form-group"><label for="creatinine">Cr√©atinine (mg/L)</label><input type="number" id="creatinine" step="0.1"></div>
                <div class="form-group"><label for="acide-urique">Acide urique (mg/L)</label><input type="number" id="acide-urique" step="0.1"></div>
                <div class="form-group"><label for="asat">ASAT (UI/L)</label><input type="text" id="asat"></div>
                <div class="form-group"><label for="alat">ALAT (UI/L)</label><input type="text" id="alat"></div>
            </div>
        </div>
        <div class="form-section">
            <h3>H√©matologie</h3>
            <div class="form-grid">
                <div class="form-group"><label for="hemoglobine">H√©moglobine (g/dL)</label><input type="number" id="hemoglobine" step="0.1"></div>
                <div class="form-group"><label for="hematocrite">H√©matocrite (%)</label><input type="number" id="hematocrite" step="0.1"></div>
                <div class="form-group"><label for="leucocytes">Leucocytes (/mm¬≥)</label><input type="number" id="leucocytes"></div>
                <div class="form-group"><label for="plaquettes">Plaquettes (/mm¬≥)</label><input type="number" id="plaquettes"></div>
            </div>
        </div>
        <div class="form-section">
            <h3>Examens d'Imagerie</h3>
            <div class="form-group"><label for="radio-thorax">Radiographie thoracique</label><textarea id="radio-thorax" rows="3"></textarea></div>
            <div class="form-group"><label for="ecg">ECG</label><textarea id="ecg" rows="3"></textarea></div>
            <div class="form-group"><label for="echographie">√âchographie</label><textarea id="echographie" rows="3"></textarea></div>
        </div>
        <div class="form-section">
            <h3>Examens Fonctionnels</h3>
            <div class="form-group"><label for="audiometrie">Audiom√©trie</label><textarea id="audiometrie" rows="3"></textarea></div>
            <div class="form-group"><label for="spirometrie">Spirom√©trie</label><textarea id="spirometrie" rows="3"></textarea></div>
            <div class="form-group">
                <label for="vision">Examen de la vision</label>
                <div class="form-grid">
                    <input type="text" id="vision-od" placeholder="≈íil droit (OD)">
                    <input type="text" id="vision-og" placeholder="≈íil gauche (OG)">
                    <input type="text" id="vision-binoculaire" placeholder="Vision binoculaire">
                </div>
            </div>
        </div>
        <div class="form-section">
            <h3>Autres examens</h3>
            <div class="form-group"><label for="autres-examens">Autres examens r√©alis√©s</label><textarea id="autres-examens" rows="4"></textarea></div>
        </div>
    </div>

    <!-- ONGLET 5: VACCINATIONS -->
    <div id="vaccinations" class="tab-content">
        <h2>üíâ Vaccinations</h2>
        <div class="form-section">
            <h3>Vaccinations Obligatoires</h3>
            <div class="form-grid">
                <div class="form-group"><label for="vaccin-dt-polio">DT-Polio (derni√®re dose)</label><input type="text" id="vaccin-dt-polio" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-dt-rappel">Prochain rappel DT-Polio</label><input type="text" id="vaccin-dt-rappel" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-hepatite-b">H√©patite B</label>
                    <select id="vaccin-hepatite-b"><option value="">Non renseign√©</option><option value="complet">Sch√©ma complet</option><option value="encours">En cours</option><option value="non">Non vaccin√©</option><option value="immunise">Immunis√©</option></select>
                </div>
                <div class="form-group"><label for="date-hepatite-b">Date derni√®re dose H√©patite B</label><input type="text" id="date-hepatite-b" placeholder="JJ/MM/AAAA"></div>
            </div>
        </div>
        <div class="form-section">
            <h3>Vaccinations Recommand√©es</h3>
            <div class="form-grid">
                <div class="form-group"><label for="vaccin-bcg">BCG</label><select id="vaccin-bcg"><option value="">Non renseign√©</option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                <div class="form-group"><label for="date-bcg">Date BCG</label><input type="text" id="date-bcg" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-hepatite-a">H√©patite A</label><select id="vaccin-hepatite-a"><option value="">Non renseign√©</option><option value="complet">Complet</option><option value="partiel">Partiel</option><option value="non">Non</option></select></div>
                <div class="form-group"><label for="date-hepatite-a">Date H√©patite A</label><input type="text" id="date-hepatite-a" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-typhoide">Typho√Øde</label><select id="vaccin-typhoide"><option value="">Non renseign√©</option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                <div class="form-group"><label for="date-typhoide">Date Typho√Øde</label><input type="text" id="date-typhoide" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-leptospirose">Leptospirose</label><select id="vaccin-leptospirose"><option value="">Non renseign√©</option><option value="oui">Oui</option><option value="non">Non</option></select></div>
                <div class="form-group"><label for="date-leptospirose">Date Leptospirose</label><input type="text" id="date-leptospirose" placeholder="JJ/MM/AAAA"></div>
            </div>
        </div>
        <div class="form-section">
            <h3>Vaccinations Saisonni√®res</h3>
            <div class="form-grid">
                <div class="form-group"><label for="vaccin-grippe">Grippe saisonni√®re</label><select id="vaccin-grippe"><option value="">Non renseign√©</option><option value="oui-annee">Oui cette ann√©e</option><option value="oui-precedent">Oui ann√©e pr√©c√©dente</option><option value="non">Non</option></select></div>
                <div class="form-group"><label for="date-grippe">Date derni√®re grippe</label><input type="text" id="date-grippe" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="vaccin-covid">COVID-19</label><select id="vaccin-covid"><option value="">Non renseign√©</option><option value="complet-rappel">Complet + rappel</option><option value="complet">Complet</option><option value="partiel">Partiel</option><option value="non">Non vaccin√©</option></select></div>
                <div class="form-group"><label for="date-covid">Date dernier COVID-19</label><input type="text" id="date-covid" placeholder="JJ/MM/AAAA"></div>
            </div>
        </div>
        <div class="form-section">
            <h3>Autres Vaccinations</h3>
            <div class="form-group"><label for="autres-vaccins">Autres vaccinations</label><textarea id="autres-vaccins" rows="4"></textarea></div>
            <div class="form-group"><label for="serologies">S√©rologies r√©alis√©es</label><textarea id="serologies" rows="3"></textarea></div>
        </div>
    </div>

    <!-- ONGLET 6: RISQUES PROFESSIONNELS -->
    <div id="risques" class="tab-content">
        <h2>‚ö†Ô∏è √âvaluation des Risques Professionnels</h2>
        <div class="form-section"><h3>Risques Physiques</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="risque-phys" value="bruit"> Bruit > 80 dB</label>
                <label><input type="checkbox" name="risque-phys" value="vibrations"> Vibrations</label>
                <label><input type="checkbox" name="risque-phys" value="rayonnements-ionisants"> Rayonnements ionisants</label>
                <label><input type="checkbox" name="risque-phys" value="rayonnements-non-ionisants"> Rayonnements non ionisants</label>
                <label><input type="checkbox" name="risque-phys" value="chaleur"> Temp√©ratures extr√™mes (chaud)</label>
                <label><input type="checkbox" name="risque-phys" value="froid"> Temp√©ratures extr√™mes (froid)</label>
                <label><input type="checkbox" name="risque-phys" value="pression"> Pression</label>
                <label><input type="checkbox" name="risque-phys" value="electricite"> √âlectricit√©</label>
            </div>
        </div>
        <div class="form-section"><h3>Risques Chimiques</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="risque-chim" value="cmr"> Agents CMR</label>
                <label><input type="checkbox" name="risque-chim" value="acd"> Agents chimiques dangereux</label>
                <label><input type="checkbox" name="risque-chim" value="poussieres"> Poussi√®res</label>
                <label><input type="checkbox" name="risque-chim" value="fumees"> Fum√©es</label>
                <label><input type="checkbox" name="risque-chim" value="gaz"> Gaz/Vapeurs</label>
                <label><input type="checkbox" name="risque-chim" value="solvants"> Solvants</label>
                <label><input type="checkbox" name="risque-chim" value="metaux"> M√©taux lourds</label>
                <label><input type="checkbox" name="risque-chim" value="amiante"> Amiante</label>
            </div>
            <div class="form-group"><label for="produits-utilises">Produits chimiques utilis√©s</label><textarea id="produits-utilises" rows="3"></textarea></div>
        </div>
        <div class="form-section"><h3>Risques Biologiques</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="risque-bio" value="groupe1"> Groupe 1</label>
                <label><input type="checkbox" name="risque-bio" value="groupe2"> Groupe 2</label>
                <label><input type="checkbox" name="risque-bio" value="groupe3"> Groupe 3</label>
                <label><input type="checkbox" name="risque-bio" value="groupe4"> Groupe 4</label>
            </div>
        </div>
        <div class="form-section"><h3>Contraintes Physiques et Ergonomiques</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="contrainte" value="manutention"> Manutention manuelle</label>
                <label><input type="checkbox" name="contrainte" value="postures"> Postures p√©nibles</label>
                <label><input type="checkbox" name="contrainte" value="gestes-repetitifs"> Gestes r√©p√©titifs</label>
                <label><input type="checkbox" name="contrainte" value="station-debout"> Station debout prolong√©e</label>
                <label><input type="checkbox" name="contrainte" value="position-assise"> Position assise prolong√©e</label>
                <label><input type="checkbox" name="contrainte" value="ecran"> Travail sur √©cran > 4h/jour</label>
                <label><input type="checkbox" name="contrainte" value="conduite"> Conduite de v√©hicules</label>
                <label><input type="checkbox" name="contrainte" value="machines"> Machines dangereuses</label>
            </div>
        </div>
        <div class="form-section"><h3>Risques Psychosociaux</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="risque-psy" value="stress"> Stress chronique</label>
                <label><input type="checkbox" name="risque-psy" value="horaires-atypiques"> Horaires atypiques</label>
                <label><input type="checkbox" name="risque-psy" value="travail-nuit"> Travail de nuit</label>
                <label><input type="checkbox" name="risque-psy" value="travail-isole"> Travail isol√©</label>
                <label><input type="checkbox" name="risque-psy" value="contact-public"> Contact avec le public</label>
                <label><input type="checkbox" name="risque-psy" value="violence"> Risque de violence</label>
            </div>
        </div>
        <div class="form-section"><h3>EPI</h3>
            <div class="checkbox-group">
                <label><input type="checkbox" name="epi" value="casque"> Casque</label>
                <label><input type="checkbox" name="epi" value="lunettes"> Lunettes</label>
                <label><input type="checkbox" name="epi" value="ecran-facial"> √âcran facial</label>
                <label><input type="checkbox" name="epi" value="protection-auditive"> Protection auditive</label>
                <label><input type="checkbox" name="epi" value="masque-anti-poussiere"> Masque anti-poussi√®re</label>
                <label><input type="checkbox" name="epi" value="masque-ffp2"> Masque FFP2/FFP3</label>
                <label><input type="checkbox" name="epi" value="appareil-respiratoire"> Appareil respiratoire</label>
                <label><input type="checkbox" name="epi" value="gants"> Gants</label>
                <label><input type="checkbox" name="epi" value="chaussures"> Chaussures</label>
                <label><input type="checkbox" name="epi" value="vetements"> V√™tements</label>
                <label><input type="checkbox" name="epi" value="harnais"> Harnais</label>
            </div>
        </div>
        <div class="form-section"><h3>SMR</h3>
            <div class="form-group"><label for="smr-justification">Justification SMR</label><textarea id="smr-justification" rows="3"></textarea></div>
        </div>
    </div>

    <!-- ONGLET 7: CONCLUSION -->
    <div id="conclusion" class="tab-content">
        <h2>‚úÖ Conclusion et Aptitude</h2>
        <div class="form-section"><h3>Type de Visite</h3>
            <div class="form-group"><label for="type-visite">Nature de la visite <span class="required">*</span></label>
                <select id="type-visite" required>
                    <option value="">S√©lectionner</option>
                    <option value="embauche">Visite d'embauche</option>
                    <option value="periodique">Visite p√©riodique</option>
                    <option value="reprise">Visite de reprise</option>
                    <option value="pre-reprise">Visite de pr√©-reprise</option>
                    <option value="demande">Visite √† la demande</option>
                    <option value="mi-carriere">Visite de mi-carri√®re</option>
                    <option value="fin-carriere">Visite de fin de carri√®re</option>
                </select>
            </div>
        </div>
        <div class="form-section"><h3>Avis d'Aptitude</h3>
            <div class="form-group"><label for="aptitude">D√©cision d'aptitude <span class="required">*</span></label>
                <select id="aptitude" required onchange="gererAptitude()">
                    <option value="">S√©lectionner une d√©cision</option>
                    <option value="apte">‚úÖ APTE √† son poste de travail</option>
                    <option value="apte-poste-propose">‚úÖ APTE au poste propos√©</option>
                    <option value="indemne">‚úÖ INDEMNE de toute maladie professionnelle</option>
                    <option value="apte-amenagement">‚ö†Ô∏è APTE avec am√©nagement de poste</option>
                    <option value="apte-restrictions">‚ö†Ô∏è APTE avec restrictions</option>
                    <option value="inapte-temporaire">‚è∏Ô∏è INAPTE temporairement</option>
                    <option value="inapte">‚ùå INAPTE au poste de travail</option>
                </select>
            </div>
            <div class="form-group" id="div-restrictions" style="display:none;">
                <label for="restrictions">Pr√©cisions sur les restrictions/am√©nagements</label>
                <textarea id="restrictions" rows="4"></textarea>
            </div>
            <div class="form-group" id="div-duree-inaptitude" style="display:none;">
                <label for="duree-inaptitude">Dur√©e de l'inaptitude temporaire</label>
                <input type="text" id="duree-inaptitude" placeholder="Ex: 3 mois">
            </div>
        </div>
        <div class="form-section"><h3>Recommandations et Suivi</h3>
            <div class="form-group"><label for="recommandations">Recommandations m√©dicales</label><textarea id="recommandations" rows="4"></textarea></div>
            <div class="form-group"><label for="orientations">Orientations m√©dicales</label><textarea id="orientations" rows="3"></textarea></div>
            <div class="form-group"><label for="examens-complementaires">Examens compl√©mentaires √† pr√©voir</label><textarea id="examens-complementaires" rows="3"></textarea></div>
        </div>
        <div class="form-section"><h3>Validation du Certificat</h3>
            <div class="form-grid">
                <div class="form-group"><label for="date-examen">Date de l'examen <span class="required">*</span></label><input type="text" id="date-examen" placeholder="JJ/MM/AAAA" required></div>
                <div class="form-group"><label for="prochaine-visite">Prochaine visite pr√©vue</label><input type="text" id="prochaine-visite" placeholder="JJ/MM/AAAA"></div>
                <div class="form-group"><label for="medecin">M√©decin du travail</label><input type="text" id="medecin" placeholder="Dr. "></div>
                <div class="form-group"><label for="numero-ordre">N¬∞ Ordre</label><input type="text" id="numero-ordre"></div>
                <div class="form-group"><label for="lieu-examen">Lieu de l'examen</label><input type="text" id="lieu-examen"></div>
                <div class="form-group"><label for="signature">Code de validation</label><input type="password" id="signature" placeholder="Code m√©decin"></div>
            </div>
        </div>
        <div class="form-section" style="background: #fff3cd; border: 2px solid #ffc107;">
            <h3 style="color: #856404;">‚ö†Ô∏è Rappel R√©glementaire</h3>
            <p style="font-size: 14px; color: #856404;">
                Ce certificat d'aptitude est √©tabli conform√©ment aux dispositions du Code du Travail.
                Le salari√© dispose d'un d√©lai de 15 jours pour contester cet avis aupr√®s de l'inspection du travail.
            </p>
        </div>
    </div>
</div>

<!-- BARRE D'ACTIONS FIXE -->
<div class="action-bar-fixed">
    <div class="action-bar-content" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button onclick="sauvegarderDossier()" 
                style="padding: 14px 28px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                       color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; 
                       font-size: 16px; box-shadow: 0 4px 15px rgba(40,167,69,0.3); transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-3px)'"
                onmouseout="this.style.transform='translateY(0)'">
            üíæ Sauvegarder
        </button>
        
        <div style="position: relative; display: inline-block;">
            <button onclick="toggleMenuDocuments()" 
                    style="padding: 14px 28px; background: #667eea; color: white; border: none; 
                           border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px;
                           box-shadow: 0 4px 15px rgba(102,126,234,0.3); transition: all 0.3s;
                           display: flex; align-items: center; gap: 8px;"
                    onmouseover="this.style.transform='translateY(-3px)'"
                    onmouseout="this.style.transform='translateY(0)'">
                üìÑ Documents <span style="font-size: 12px;">‚ñº</span>
            </button>
            <div id="menuDocuments" style="
                display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
                background: white; border: 2px solid #667eea; border-radius: 10px;
                box-shadow: 0 -8px 30px rgba(0,0,0,0.15); z-index: 10000; min-width: 280px; margin-bottom: 10px;
            ">
                <button onclick="previsualiser(); toggleMenuDocuments()" style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; border-radius: 10px 10px 0 0; transition: all 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    <span style="font-size: 20px;">üëÅÔ∏è</span> Pr√©visualiser
                </button>
                <button onclick="imprimerCertificatAptitude(); toggleMenuDocuments()" style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px; transition: all 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    <span style="font-size: 20px;">üìú</span> Certificat d'Aptitude
                </button>
                <button onclick="genererRapportMedical(); toggleMenuDocuments()" style="width: 100%; padding: 14px 20px; text-align: left; border: none; background: white; cursor: pointer; font-size: 14px; border-radius: 0 0 10px 10px; display: flex; align-items: center; gap: 12px; transition: all 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    <span style="font-size: 20px;">üìã</span> Rapport M√©dical Complet
                </button>
            </div>
        </div>
        
        <button onclick="reinitialiser()" 
                style="padding: 14px 28px; background: #6c757d; color: white; border: none; 
                       border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px;
                       box-shadow: 0 4px 15px rgba(108,117,125,0.3); transition: all 0.3s;"
                onmouseover="this.style.transform='translateY(-3px)'"
                onmouseout="this.style.transform='translateY(0)'">
            üîÑ R√©initialiser
        </button>
    </div>
</div>

<!-- BOUTON FLOTTANT NOUVELLE FICHE -->
<div style="position: fixed; bottom: 100px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 999;">
    <button onclick="nouvelleFiche()" style="
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white; border: none; width: 60px; height: 60px; border-radius: 50%;
        font-size: 24px; cursor: pointer; box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
    " title="Nouvelle Fiche">‚ûï</button>
</div>

<!-- FOOTER -->
<footer style="
    text-align: center; padding: 20px; margin-top: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; font-size: 14px;
">
    <div><strong>APSUMEDTRAV</strong> Version 3.0.0 - Multi-Utilisateurs | Firestore</div>
    <div style="margin-top: 5px; opacity: 0.9;">¬© 2024 Dr.Nowa Sant√© au Travail - Tous droits r√©serv√©s</div>
    <div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">Contact | T√©l : +24397219565</div>
</footer>

<!-- ============================================ -->
<!-- JAVASCRIPT PRINCIPAL - VERSION FIRESTORE -->
<!-- ============================================ -->
<script>
'use strict';

// ============================================
// 1. CONFIGURATION & INITIALISATION FIREBASE
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBYj1zLDYLhoDOYKmMA9zd6nuoYSbGilBo",
    authDomain: "apsumedtrav.firebaseapp.com",
    projectId: "apsumedtrav",
    storageBucket: "apsumedtrav.firebasestorage.app",
    messagingSenderId: "705292661823",
    appId: "1:705292661823:web:5d4b52f5a842b25f83348a"
};

// üî• NOUVEAU : Initialisation effective de Firebase
firebase.initializeApp(firebaseConfig);
const firestoreDB = firebase.firestore();
const auth = firebase.auth();

// üî• NOUVEAU : Activer la persistance hors-ligne (cache local)
firestoreDB.enablePersistence({ synchronizeTabs: true })
    .then(() => console.log('‚úÖ Persistance Firestore activ√©e'))
    .catch(err => {
        if (err.code === 'failed-precondition') {
            console.warn('‚ö†Ô∏è Persistance impossible : plusieurs onglets ouverts');
        } else if (err.code === 'unimplemented') {
            console.warn('‚ö†Ô∏è Persistance non support√©e par ce navigateur');
        }
    });

// üî• NOUVEAU : Variable utilisateur connect√©
let utilisateurConnecte = null;
let ecouteursTempReel = []; // Pour stocker les unsubscribe des listeners

// ============================================
// üî• NOUVEAU : SYST√àME D'AUTHENTIFICATION
// ============================================
function setSyncStatus(status, text) {
    const ind = document.getElementById('syncIndicator');
    if (ind) {
        ind.className = status;
        ind.textContent = text;
    }
}

function connexion() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = '';

    if (!email || !password) {
        errorDiv.textContent = '‚ö†Ô∏è Veuillez remplir tous les champs.';
        return;
    }

    errorDiv.textContent = '‚è≥ Connexion en cours...';
    errorDiv.style.color = '#667eea';

    auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
            console.log('‚úÖ Connect√©:', userCredential.user.email);
        })
        .catch(error => {
            console.error('‚ùå Erreur connexion:', error);
            errorDiv.style.color = '#dc3545';
            switch (error.code) {
                case 'auth/user-not-found':
                    errorDiv.textContent = '‚ùå Aucun compte avec cet email. Cr√©ez un compte.';
                    break;
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    errorDiv.textContent = '‚ùå Mot de passe incorrect.';
                    break;
                case 'auth/invalid-email':
                    errorDiv.textContent = '‚ùå Format d\'email invalide.';
                    break;
                case 'auth/too-many-requests':
                    errorDiv.textContent = '‚ùå Trop de tentatives. R√©essayez plus tard.';
                    break;
                default:
                    errorDiv.textContent = '‚ùå Erreur : ' + error.message;
            }
        });
}

function inscription() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = '';

    if (!email || !password) {
        errorDiv.textContent = '‚ö†Ô∏è Veuillez remplir tous les champs.';
        return;
    }
    if (password.length < 6) {
        errorDiv.textContent = '‚ö†Ô∏è Le mot de passe doit avoir au moins 6 caract√®res.';
        return;
    }

    errorDiv.textContent = '‚è≥ Cr√©ation du compte...';
    errorDiv.style.color = '#667eea';

    auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
            console.log('‚úÖ Compte cr√©√©:', userCredential.user.email);
            // Enregistrer le profil dans Firestore
            return firestoreDB.collection('utilisateurs').doc(userCredential.user.uid).set({
                email: email,
                dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                role: 'medecin'
            });
        })
        .catch(error => {
            console.error('‚ùå Erreur inscription:', error);
            errorDiv.style.color = '#dc3545';
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorDiv.textContent = '‚ùå Cet email est d√©j√† utilis√©. Connectez-vous.';
                    break;
                case 'auth/weak-password':
                    errorDiv.textContent = '‚ùå Mot de passe trop faible (min 6 caract√®res).';
                    break;
                default:
                    errorDiv.textContent = '‚ùå Erreur : ' + error.message;
            }
        });
}

function deconnexion() {
    // D√©tacher les √©couteurs temps r√©el
    ecouteursTempReel.forEach(unsub => unsub());
    ecouteursTempReel = [];

    auth.signOut().then(() => {
        console.log('‚úÖ D√©connect√©');
        utilisateurConnecte = null;
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('userBar').style.display = 'none';
    });
}

// üî• NOUVEAU : Observer les changements d'√©tat d'authentification
auth.onAuthStateChanged(user => {
    if (user) {
        utilisateurConnecte = user;
        console.log('üë§ Utilisateur connect√©:', user.email);

        // Masquer le login, afficher la barre utilisateur
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('userBar').style.display = 'block';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];

        // Lancer les √©couteurs temps r√©el
        demarrerEcouteTempsReel();

        // Migrer les donn√©es localStorage vers Firestore si n√©cessaire
        migrerLocalStorageVersFirestore();

    } else {
        utilisateurConnecte = null;
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('userBar').style.display = 'none';
    }
});

// ============================================
// üî• NOUVEAU : COUCHE D'ABSTRACTION FIRESTORE
// ============================================

// -- Sauvegarder un travailleur et sa consultation --
async function sauvegarderDansFirestore(matricule, infosTravailleur, consultation) {
    setSyncStatus('sync-loading', 'üü° Synchronisation...');
    try {
        const batch = firestoreDB.batch();

        // Document principal du travailleur
        const travailleurRef = firestoreDB.collection('travailleurs').doc(matricule);
        batch.set(travailleurRef, {
            ...infosTravailleur,
            derniereMiseAJour: firebase.firestore.FieldValue.serverTimestamp(),
            misAJourPar: utilisateurConnecte?.email || 'inconnu'
        }, { merge: true });

        // Sous-collection consultations
        const consultId = consultation.id.toString();
        const consultRef = travailleurRef.collection('consultations').doc(consultId);
        batch.set(consultRef, {
            ...consultation,
            enregistrePar: utilisateurConnecte?.email || 'inconnu',
            timestampServeur: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();
        console.log('‚úÖ Firestore: sauvegarde r√©ussie pour', matricule);
        setSyncStatus('sync-ok', 'üü¢ Synchronis√©');
        return true;
    } catch (error) {
        console.error('‚ùå Firestore: erreur sauvegarde:', error);
        setSyncStatus('sync-error', 'üî¥ Erreur sync');
        return false;
    }
}

// -- Lire tous les travailleurs --
async function lireTousTravailleurs() {
    try {
        const snapshot = await firestoreDB.collection('travailleurs').orderBy('nom').get();
        const travailleurs = [];
        snapshot.forEach(doc => {
            travailleurs.push({ matricule: doc.id, ...doc.data() });
        });
        console.log(`üìä Firestore: ${travailleurs.length} travailleur(s) lus`);
        return travailleurs;
    } catch (error) {
        console.error('‚ùå Firestore: erreur lecture travailleurs:', error);
        // Fallback localStorage
        return JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
    }
}

// -- Lire l'historique d'un travailleur --
async function lireHistorique(matricule) {
    try {
        const snapshot = await firestoreDB.collection('travailleurs').doc(matricule)
            .collection('consultations')
            .orderBy('dateSauvegarde', 'desc')
            .get();
        const historique = [];
        snapshot.forEach(doc => {
            historique.push(doc.data());
        });
        console.log(`üìä Firestore: ${historique.length} consultation(s) pour ${matricule}`);
        // Mettre en cache local
        localStorage.setItem(`historique_${matricule}`, JSON.stringify(historique));
        return historique;
    } catch (error) {
        console.error('‚ùå Firestore: erreur lecture historique:', error);
        return JSON.parse(localStorage.getItem(`historique_${matricule}`) || '[]');
    }
}

// -- Supprimer un travailleur --
async function supprimerDansFirestore(matricule) {
    try {
        // Supprimer toutes les consultations (sous-collection)
        const consultations = await firestoreDB.collection('travailleurs').doc(matricule)
            .collection('consultations').get();
        const batch = firestoreDB.batch();
        consultations.forEach(doc => batch.delete(doc.ref));
        // Supprimer le document principal
        batch.delete(firestoreDB.collection('travailleurs').doc(matricule));
        await batch.commit();
        console.log('‚úÖ Firestore: travailleur supprim√©:', matricule);
        return true;
    } catch (error) {
        console.error('‚ùå Firestore: erreur suppression:', error);
        return false;
    }
}

// -- Supprimer une consultation --
async function supprimerConsultationFirestore(matricule, consultationId) {
    try {
        await firestoreDB.collection('travailleurs').doc(matricule)
            .collection('consultations').doc(consultationId.toString()).delete();

        // Recalculer le nombre de consultations
        const snapshot = await firestoreDB.collection('travailleurs').doc(matricule)
            .collection('consultations').get();
        await firestoreDB.collection('travailleurs').doc(matricule).update({
            nombreConsultations: snapshot.size,
            derniereMiseAJour: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log('‚úÖ Firestore: consultation supprim√©e');
        return true;
    } catch (error) {
        console.error('‚ùå Firestore: erreur suppression consultation:', error);
        return false;
    }
}

// ============================================
// üî• NOUVEAU : √âCOUTE TEMPS R√âEL
// ============================================
function demarrerEcouteTempsReel() {
    console.log('üëÇ D√©marrage de l\'√©coute temps r√©el...');

    // √âcouter les changements sur la collection travailleurs
    const unsub = firestoreDB.collection('travailleurs')
        .onSnapshot(snapshot => {
            console.log('üîÑ Mise √† jour temps r√©el re√ßue');
            const travailleurs = [];
            snapshot.forEach(doc => {
                travailleurs.push({ matricule: doc.id, ...doc.data() });
            });

            // Mettre √† jour le cache local
            localStorage.setItem('liste_travailleurs', JSON.stringify(travailleurs));

            // Actualiser l'affichage si le panneau est visible
            const panel = document.getElementById('searchHistoryPanel');
            if (panel && panel.style.display !== 'none') {
                afficherResultats(travailleurs);
                updateStatistiquesDepuisListe(travailleurs);
            }

            setSyncStatus('sync-ok', 'üü¢ Synchronis√©');
        }, error => {
            console.error('‚ùå Erreur √©coute temps r√©el:', error);
            setSyncStatus('sync-error', 'üî¥ Hors ligne');
        });

    ecouteursTempReel.push(unsub);
}

// ============================================
// üî• NOUVEAU : MIGRATION localStorage ‚Üí Firestore
// ============================================
async function migrerLocalStorageVersFirestore() {
    const dejaMigre = localStorage.getItem('migration_firestore_done');
    if (dejaMigre) return;

    console.log('üîÑ V√©rification de la migration localStorage ‚Üí Firestore...');

    const listeLocale = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
    if (listeLocale.length === 0) {
        localStorage.setItem('migration_firestore_done', 'true');
        return;
    }

    const snapshotFirestore = await firestoreDB.collection('travailleurs').limit(1).get();
    if (!snapshotFirestore.empty) {
        console.log('‚ÑπÔ∏è Firestore contient d√©j√† des donn√©es, migration ignor√©e');
        localStorage.setItem('migration_firestore_done', 'true');
        return;
    }

    console.log(`üöÄ Migration de ${listeLocale.length} travailleur(s) vers Firestore...`);
    setSyncStatus('sync-loading', 'üü° Migration...');

    let migres = 0;
    for (const travailleur of listeLocale) {
        try {
            const matricule = travailleur.matricule;
            if (!matricule) continue;

            // Sauvegarder les infos du travailleur
            await firestoreDB.collection('travailleurs').doc(matricule).set({
                nom: travailleur.nom || '',
                prenom: travailleur.prenom || '',
                entreprise: travailleur.entreprise || '',
                poste: travailleur.poste || '',
                nombreConsultations: travailleur.nombreConsultations || 0,
                derniereConsultation: travailleur.derniereConsultation || '',
                derniereAptitude: travailleur.derniereAptitude || '',
                derniereMiseAJour: firebase.firestore.FieldValue.serverTimestamp(),
                misAJourPar: utilisateurConnecte?.email || 'migration'
            });

            // Migrer les consultations
            const historique = JSON.parse(localStorage.getItem(`historique_${matricule}`) || '[]');
            for (const consult of historique) {
                const consultId = (consult.id || Date.now()).toString();
                await firestoreDB.collection('travailleurs').doc(matricule)
                    .collection('consultations').doc(consultId).set({
                        ...consult,
                        enregistrePar: 'migration',
                        timestampServeur: firebase.firestore.FieldValue.serverTimestamp()
                    });
            }

            migres++;
            console.log(`  ‚úÖ ${matricule}: ${travailleur.nom} (${historique.length} consultations)`);
        } catch (err) {
            console.error(`  ‚ùå Erreur migration ${travailleur.matricule}:`, err);
        }
    }

    localStorage.setItem('migration_firestore_done', 'true');
    console.log(`‚úÖ Migration termin√©e: ${migres}/${listeLocale.length} travailleurs migr√©s`);
    setSyncStatus('sync-ok', 'üü¢ Migr√©');
}

// ============================================
// 2. GESTION DES ONGLETS (inchang√©)
// ============================================
function openTab(evt, tabName) {
    const tabcontent = document.getElementsByClassName("tab-content");
    const tabs = document.getElementsByClassName("tab");
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].classList.remove("active");
    }
    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove("active");
    }
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.style.display = "block";
        selectedTab.classList.add("active");
        evt.currentTarget.classList.add("active");
    }
}

// ============================================
// 3. FORMATAGE AUTOMATIQUE DES DATES (inchang√©)
// ============================================
function formaterDate(input) {
    let value = input.value.replace(/\D/g, '');
    let formattedValue = '';
    if (value.length > 0) {
        if (value.length <= 2) formattedValue = value;
        else if (value.length <= 4) formattedValue = value.slice(0, 2) + '/' + value.slice(2);
        else formattedValue = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4, 8);
    }
    input.value = formattedValue;
}

// ============================================
// 4. CALCUL DE L'√ÇGE (inchang√©)
// ============================================
function calculerAge() {
    const dateNaissanceInput = document.getElementById('date-naissance');
    const ageInput = document.getElementById('age');
    if (!dateNaissanceInput || !ageInput) return;
    const dateStr = dateNaissanceInput.value;
    if (dateStr.length === 10) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const dateNaissance = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            const aujourdhui = new Date();
            let age = aujourdhui.getFullYear() - dateNaissance.getFullYear();
            const moisDiff = aujourdhui.getMonth() - dateNaissance.getMonth();
            if (moisDiff < 0 || (moisDiff === 0 && aujourdhui.getDate() < dateNaissance.getDate())) age--;
            if (age > 0 && age < 120) ageInput.value = age + ' ans';
        }
    }
}

// ============================================
// 5. CALCUL ANCIENNET√â (inchang√©)
// ============================================
(function initAnciennete() {
    const dateEmbauche = document.getElementById('date-embauche');
    const dateConsultation = document.getElementById('date-consultation');
    const anciennete = document.getElementById('anciennete');
    if (!dateEmbauche || !anciennete) return;

    function calculerAnciennete() {
        const dateEmbaucheTxt = dateEmbauche.value;
        if (!dateEmbaucheTxt) { anciennete.textContent = '-- ans -- mois'; return; }
        let dateE;
        if (dateEmbaucheTxt.includes('/')) {
            const [jour, mois, annee] = dateEmbaucheTxt.split('/');
            dateE = new Date(annee, mois - 1, jour);
        } else if (dateEmbaucheTxt.includes('-')) { dateE = new Date(dateEmbaucheTxt); }
        else return;

        let dateC;
        if (dateConsultation && dateConsultation.value) {
            const txt = dateConsultation.value;
            if (txt.includes('/')) { const [j, m, a] = txt.split('/'); dateC = new Date(a, m - 1, j); }
            else dateC = new Date(txt);
        } else dateC = new Date();

        let annees = dateC.getFullYear() - dateE.getFullYear();
        let mois = dateC.getMonth() - dateE.getMonth();
        if (mois < 0) { annees--; mois += 12; }
        anciennete.textContent = annees + ' ans ' + mois + ' mois';
    }

    ['input', 'blur', 'change'].forEach(evt => {
        dateEmbauche.addEventListener(evt, calculerAnciennete);
        if (dateConsultation) dateConsultation.addEventListener(evt, calculerAnciennete);
    });
    if (dateEmbauche.value) calculerAnciennete();
})();

// ============================================
// 6. CALCUL DE L'IMC (inchang√©)
// ============================================
function calculerIMC() {
    const poids = parseFloat(document.getElementById('poids')?.value);
    const taille = parseFloat(document.getElementById('taille')?.value);
    const imcInput = document.getElementById('imc');
    const interpInput = document.getElementById('interpretation-imc');
    if (poids > 0 && taille > 0 && imcInput) {
        const tailleM = taille / 100;
        const imc = (poids / (tailleM * tailleM)).toFixed(2);
        imcInput.value = imc;
        if (interpInput) {
            const v = parseFloat(imc);
            interpInput.value = v < 18.5 ? 'Maigreur' : v < 25 ? 'Poids normal' : v < 30 ? 'Surpoids' : v < 35 ? 'Ob√©sit√© mod√©r√©e' : v < 40 ? 'Ob√©sit√© s√©v√®re' : 'Ob√©sit√© morbide';
        }
    }
}

// ============================================
// 7. GESTION DE L'APTITUDE (inchang√©)
// ============================================
function gererAptitude() {
    const val = document.getElementById('aptitude')?.value;
    const divR = document.getElementById('div-restrictions');
    const divD = document.getElementById('div-duree-inaptitude');
    if (divR && divD) {
        divR.style.display = (val === 'apte-amenagement' || val === 'apte-restrictions') ? 'block' : 'none';
        divD.style.display = (val === 'inapte-temporaire') ? 'block' : 'none';
    }
}

// ============================================
// 8. üî• MODIFI√â : SAUVEGARDE - Firestore + localStorage
// ============================================
async function sauvegarderDossier() {
    try {
        const matricule = document.getElementById('matricule')?.value?.trim();
        const dateExamen = document.getElementById('date-examen')?.value;

        if (!matricule) {
            alert('‚ö†Ô∏è Veuillez saisir un MATRICULE avant de sauvegarder.');
            document.getElementById('matricule')?.focus();
            return;
        }
        if (!dateExamen) {
            alert('‚ö†Ô∏è Veuillez saisir une DATE D\'EXAMEN.');
            document.getElementById('date-examen')?.focus();
            return;
        }

        setSyncStatus('sync-loading', 'üü° Sauvegarde...');

        // Construction de l'objet consultation (identique √† l'original)
        const consultation = {
            id: Date.now(),
            dateConsultation: dateExamen,
            dateSauvegarde: new Date().toISOString(),
            medecin: document.getElementById('medecin')?.value || '',
            identification: {
                nom: document.getElementById('nom')?.value?.toUpperCase() || '',
                prenom: document.getElementById('prenom')?.value || '',
                dateNaissance: document.getElementById('date-naissance')?.value || '',
                age: document.getElementById('age')?.value || '',
                genre: document.getElementById('genre')?.value || '',
                matricule: matricule,
                telephone: document.getElementById('telephone')?.value || '',
                email: document.getElementById('email')?.value || '',
                adresse: document.getElementById('adresse')?.value || ''
            },
            professionnel: {
                entreprise: document.getElementById('entreprise')?.value || '',
                poste: document.getElementById('poste')?.value || '',
                departement: document.getElementById('departement')?.value || '',
                dateEmbauche: document.getElementById('date-embauche')?.value || '',
                anciennete: document.getElementById('anciennete')?.textContent || '',
                typeContrat: document.getElementById('type-contrat')?.value || '',
                horaireTravail: document.getElementById('horaire-travail')?.value || '',
                typeVisite: document.getElementById('type-visite')?.value || ''
            },
            antecedents: {
                medicaux: document.getElementById('autres-antecedents')?.value || '',
                chirurgicaux: document.getElementById('chirurgie')?.value || '',
                accidentTravail: document.getElementById('accident-travail')?.value || '',
                maladiePro: document.getElementById('maladie-pro')?.value || '',
                allergies: document.getElementById('allergies')?.value || '',
                tabac: document.getElementById('tabac')?.value || '',
                nbCigarettes: document.getElementById('nb-cigarettes')?.value || '',
                alcool: document.getElementById('alcool')?.value || '',
                activitePhysique: document.getElementById('activite-physique')?.value || '',
                medicaments: document.getElementById('medicaments')?.value || ''
            },
            constantes: {
                poids: document.getElementById('poids')?.value || '',
                taille: document.getElementById('taille')?.value || '',
                imc: document.getElementById('imc')?.value || '',
                interpretationIMC: document.getElementById('interpretation-imc')?.value || '',
                taSystolique: document.getElementById('ta-systolique')?.value || '',
                taDiastolique: document.getElementById('ta-diastolique')?.value || '',
                pouls: document.getElementById('pouls')?.value || '',
                frequenceResp: document.getElementById('frequence-resp')?.value || '',
                temperature: document.getElementById('temperature')?.value || '',
                saturation: document.getElementById('saturation')?.value || '',
                etatGeneral: document.getElementById('etat-general')?.value || '',
                observations: document.getElementById('observations-generales')?.value || ''
            },
            examensPhysiques: {
                cardio: document.getElementById('examen-cardio')?.value || '',
                pulm: document.getElementById('examen-pulm')?.value || '',
                abdo: document.getElementById('examen-abdo')?.value || '',
                neuro: document.getElementById('examen-neuro')?.value || '',
                osteo: document.getElementById('examen-osteo')?.value || '',
                dermato: document.getElementById('examen-dermato')?.value || '',
                orl: document.getElementById('examen-orl')?.value || '',
                ophtalmo: document.getElementById('examen-ophtalmo')?.value || ''
            },
            biologie: {
                dateBilan: document.getElementById('date-bilan')?.value || '',
                glycemie: document.getElementById('glycemie')?.value || '',
                hba1c: document.getElementById('hba1c')?.value || '',
                cholesterolTotal: document.getElementById('cholesterol-total')?.value || '',
                hdl: document.getElementById('hdl')?.value || '',
                ldl: document.getElementById('ldl')?.value || '',
                triglycerides: document.getElementById('triglycerides')?.value || '',
                creatinine: document.getElementById('creatinine')?.value || '',
                acideUrique: document.getElementById('acide-urique')?.value || '',
                asat: document.getElementById('asat')?.value || '',
                alat: document.getElementById('alat')?.value || '',
                hemoglobine: document.getElementById('hemoglobine')?.value || '',
                hematocrite: document.getElementById('hematocrite')?.value || '',
                leucocytes: document.getElementById('leucocytes')?.value || '',
                plaquettes: document.getElementById('plaquettes')?.value || ''
            },
            imagerie: {
                radioThorax: document.getElementById('radio-thorax')?.value || '',
                ecg: document.getElementById('ecg')?.value || '',
                echographie: document.getElementById('echographie')?.value || ''
            },
            examensFonctionnels: {
                audiometrie: document.getElementById('audiometrie')?.value || '',
                spirometrie: document.getElementById('spirometrie')?.value || '',
                visionOD: document.getElementById('vision-od')?.value || '',
                visionOG: document.getElementById('vision-og')?.value || '',
                visionBinoculaire: document.getElementById('vision-binoculaire')?.value || '',
                autresExamens: document.getElementById('autres-examens')?.value || ''
            },
            vaccinations: {
                dtPolio: document.getElementById('vaccin-dt-polio')?.value || '',
                hepatiteB: document.getElementById('vaccin-hepatite-b')?.value || '',
                grippe: document.getElementById('vaccin-grippe')?.value || '',
                covid: document.getElementById('vaccin-covid')?.value || ''
            },
            risques: {
                produitsUtilises: document.getElementById('produits-utilises')?.value || '',
                smrJustification: document.getElementById('smr-justification')?.value || ''
            },
            conclusion: {
                aptitude: document.getElementById('aptitude')?.value || '',
                restrictions: document.getElementById('restrictions')?.value || '',
                dureeInaptitude: document.getElementById('duree-inaptitude')?.value || '',
                recommandations: document.getElementById('recommandations')?.value || '',
                orientations: document.getElementById('orientations')?.value || '',
                examensComplementaires: document.getElementById('examens-complementaires')?.value || '',
                prochaineVisite: document.getElementById('prochaine-visite')?.value || ''
            },
            cabinet: {
                nomCabinet: document.getElementById('nom-cabinet')?.value || 'Cabinet M√©dical',
                numeroOrdre: document.getElementById('numero-ordre')?.value || '',
                lieuExamen: document.getElementById('lieu-examen')?.value || ''
            }
        };

        // --- Sauvegarde localStorage (cache local, identique √† avant) ---
        const cleHistorique = `historique_${matricule}`;
        let historique = JSON.parse(localStorage.getItem(cleHistorique) || '[]');
        const indexExistant = historique.findIndex(c => c.dateConsultation === dateExamen);
        if (indexExistant >= 0) {
            if (!confirm(`‚ö†Ô∏è Une consultation existe d√©j√† pour le ${dateExamen}.\nVoulez-vous la REMPLACER ?`)) return;
            historique[indexExistant] = consultation;
        } else {
            historique.push(consultation);
        }
        historique.sort((a, b) => new Date(b.dateSauvegarde) - new Date(a.dateSauvegarde));
        localStorage.setItem(cleHistorique, JSON.stringify(historique));

        const infosTravailleur = {
            nom: consultation.identification.nom,
            prenom: consultation.identification.prenom,
            matricule: matricule,
            entreprise: consultation.professionnel.entreprise,
            poste: consultation.professionnel.poste,
            derniereConsultation: dateExamen,
            nombreConsultations: historique.length,
            derniereAptitude: consultation.conclusion.aptitude
        };
        let listeTravailleurs = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
        const idx = listeTravailleurs.findIndex(t => t.matricule === matricule);
        if (idx >= 0) listeTravailleurs[idx] = infosTravailleur;
        else listeTravailleurs.push(infosTravailleur);
        listeTravailleurs.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''));
        localStorage.setItem('liste_travailleurs', JSON.stringify(listeTravailleurs));

        // üî• --- Sauvegarde Firestore (base partag√©e) ---
        await sauvegarderDansFirestore(matricule, infosTravailleur, consultation);

        alert(`‚úÖ Dossier sauvegard√© et synchronis√© !

üë§ ${consultation.identification.prenom} ${consultation.identification.nom}
üìÖ Consultation du ${dateExamen}
üìã Total consultations : ${historique.length}
üè• ${consultation.professionnel.entreprise}
‚òÅÔ∏è Synchronis√© avec la base partag√©e`);

        if (document.getElementById('panel-historique')?.style.display === 'block') {
            afficherHistorique(matricule);
        }

    } catch (error) {
        console.error('‚ùå Erreur sauvegarde:', error);
        setSyncStatus('sync-error', 'üî¥ Erreur');
        alert('‚ùå Erreur lors de la sauvegarde.\nD√©tails : ' + error.message);
    }
}

// ============================================
// üî• MODIFI√â : Actualiser depuis Firestore
// ============================================
async function actualiserDepuisFirestore() {
    setSyncStatus('sync-loading', 'üü° Actualisation...');
    try {
        const travailleurs = await lireTousTravailleurs();
        localStorage.setItem('liste_travailleurs', JSON.stringify(travailleurs));
        afficherResultats(travailleurs);
        updateStatistiquesDepuisListe(travailleurs);
        setSyncStatus('sync-ok', 'üü¢ Synchronis√©');
        console.log('‚úÖ Donn√©es actualis√©es depuis Firestore');
    } catch (error) {
        console.error('‚ùå Erreur actualisation:', error);
        setSyncStatus('sync-error', 'üî¥ Erreur');
    }
}

function sauvegarderEtActualiser() {
    actualiserDepuisFirestore();
}

// ============================================
// 9. CERTIFICAT D'APTITUDE (inchang√©, lit depuis le DOM)
// ============================================
function imprimerCertificatAptitude() {
    const nom = document.getElementById('nom')?.value || '';
    const prenom = document.getElementById('prenom')?.value || '';
    const dateNaissance = document.getElementById('date-naissance')?.value || '';
    const age = document.getElementById('age')?.value || '';
    const genre = document.getElementById('genre')?.options[document.getElementById('genre')?.selectedIndex]?.text || '';
    const matricule = document.getElementById('matricule')?.value || '';
    const entreprise = document.getElementById('entreprise')?.value || '';
    const poste = document.getElementById('poste')?.value || '';
    const dateEmbauche = document.getElementById('date-embauche')?.value || '';
    const anciennete = document.getElementById('anciennete')?.innerHTML || '';
    const nomCabinet = document.getElementById('nom-cabinet')?.value || 'Cabinet M√©dical';
    const typeVisite = document.getElementById('type-visite')?.options[document.getElementById('type-visite')?.selectedIndex]?.text || '';
    const aptitude = document.getElementById('aptitude')?.options[document.getElementById('aptitude')?.selectedIndex]?.text || '';
    const restrictions = document.getElementById('restrictions')?.value || '';
    const dateExamen = document.getElementById('date-examen')?.value || '';
    const prochaineVisite = document.getElementById('prochaine-visite')?.value || '';
    const medecin = document.getElementById('medecin')?.value || '';
    const numeroOrdre = document.getElementById('numero-ordre')?.value || '';
    const lieuExamen = document.getElementById('lieu-examen')?.value || '';
    const observations = document.getElementById('recommandations')?.value || '';

    const printWindow = window.open('', '', 'width=800,height=1100');
    function creerCertificat() {
        return `<div class="certificat">
            <div class="header"><h1>üè• ${nomCabinet.toUpperCase()}</h1><p>CERTIFICAT D'APTITUDE M√âDICALE AU TRAVAIL</p><p>Service de M√©decine du Travail</p></div>
            <div class="two-columns">
                <div class="column"><div class="section"><div class="section-title">IDENTIFICATION DU TRAVAILLEUR</div>
                    <div class="row"><span class="label">Nom :</span><span class="value"><strong>${nom.toUpperCase()}</strong></span></div>
                    <div class="row"><span class="label">Pr√©nom :</span><span class="value"><strong>${prenom.toUpperCase()}</strong></span></div>
                    <div class="row"><span class="label">Date de naissance :</span><span class="value">${dateNaissance}</span></div>
                    <div class="row"><span class="label">√Çge :</span><span class="value">${age}</span></div>
                    <div class="row"><span class="label">Genre :</span><span class="value">${genre}</span></div>
                    <div class="row"><span class="label">Matricule :</span><span class="value">${matricule}</span></div>
                </div></div>
                <div class="column"><div class="section"><div class="section-title">INFORMATIONS PROFESSIONNELLES</div>
                    <div class="row"><span class="label">Entreprise :</span><span class="value"><strong>${entreprise}</strong></span></div>
                    <div class="row"><span class="label">Poste :</span><span class="value">${poste}</span></div>
                    <div class="row"><span class="label">Date d'embauche :</span><span class="value">${dateEmbauche}</span></div>
                    <div class="row"><span class="label">Anciennet√© :</span><span class="value"><strong>${anciennete}</strong></span></div>
                    <div class="row"><span class="label">Type de visite :</span><span class="value">${typeVisite}</span></div>
                    <div class="row"><span class="label">Date examen :</span><span class="value">${dateExamen}</span></div>
                </div></div>
            </div>
            <div class="aptitude-box"><div>D√âCISION D'APTITUDE</div><div class="decision">${aptitude}</div>
                ${restrictions ? `<div style="margin-top:8px;text-align:left;font-size:9px;"><strong>Restrictions :</strong> ${restrictions}</div>` : ''}</div>
            ${observations ? `<div class="section" style="padding:5px;"><div class="section-title">OBSERVATIONS</div><div style="font-size:9px;">${observations.substring(0,100)}</div></div>` : ''}
            ${prochaineVisite ? `<div class="section" style="padding:5px;"><div class="row"><span class="label">Prochaine visite :</span><span class="value"><strong>${prochaineVisite}</strong></span></div></div>` : ''}
            <div class="signature-box">
                <div class="signature"><div><strong>Le M√©decin du Travail</strong></div><div style="margin-top:5px;">Dr. ${medecin}</div><div>N¬∞ Ordre : ${numeroOrdre}</div><div class="signature-line">Signature et cachet</div></div>
                <div class="stamp-area">Cachet du service</div>
            </div>
            <div class="legal-notice"><strong>‚ö†Ô∏è Rappel :</strong> D√©lai de contestation : 15 jours.</div>
            <div class="footer-info">APSUMEDTRAV - ${new Date().toLocaleDateString('fr-FR')} ${new Date().toLocaleTimeString('fr-FR')}</div>
        </div>`;
    }
    const printContent = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Certificat - ${nom} ${prenom}</title>
    <style>@page{size:A4;margin:8mm}body{font-family:Arial,sans-serif;font-size:10px;line-height:1.4;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .certificat{width:195mm;height:125mm;padding:8mm;border:2px solid #333;margin:3mm auto;box-sizing:border-box;position:relative;display:flex;flex-direction:column}
    .certificat::before{content:"APSUMEDTRAV";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);font-size:60px;color:rgba(200,200,200,.1);font-weight:bold;z-index:0;pointer-events:none}
    .certificat>*{position:relative;z-index:1}.separator{width:190mm;margin:0 auto;border-top:2px dashed #999;text-align:center;padding:2mm 0;color:#999;font-size:8px}
    .header{text-align:center;margin-bottom:5px;padding:5px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:5px;width:100%}.header h1{margin:0;font-size:14px}.header p{margin:1px 0;font-size:9px}
    .section{margin-bottom:5px;padding:5px;border:1px solid #ddd;border-radius:3px;width:100%}.section-title{font-weight:bold;font-size:10px;color:#667eea;margin-bottom:4px;border-bottom:1px solid #667eea;padding-bottom:1px;text-align:center}
    .row{display:flex;margin-bottom:2px;justify-content:center;align-items:center}.label{font-weight:bold;width:120px;color:#555;font-size:9px;text-align:right;padding-right:10px}.value{flex:1;font-size:9px;text-align:left}
    .aptitude-box{background:#e8f4ff;padding:8px;border:2px solid #667eea;border-radius:5px;margin:5px 0;text-align:center;width:100%}.aptitude-box .decision{font-size:12px;font-weight:bold;color:#667eea;margin:3px 0}
    .two-columns{display:flex;gap:5px;width:100%;justify-content:center}.column{flex:1}
    .signature-box{display:flex;justify-content:space-between;margin-top:5px;width:100%;align-items:center}.signature{width:45%;text-align:center;font-size:8px}.signature-line{border-top:1px solid #333;margin-top:15px;padding-top:2px;font-size:7px}
    .stamp-area{border:1px dashed #999;padding:10px;text-align:center;color:#999;font-size:8px;width:45%}.legal-notice{background:#fffacd;padding:5px;border-left:3px solid #ffd700;margin-top:5px;font-size:8px;line-height:1.2;width:100%;text-align:center}
    .footer-info{text-align:center;margin-top:5px;font-size:7px;color:#999;width:100%}</style></head>
    <body>${creerCertificat()}<div class="separator">‚úÇ - - - - - - - - - - ‚úÇ</div>${creerCertificat()}</body></html>`;
    printWindow.document.write(printContent);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
}

// ============================================
// 10-12. PR√âVISUALISATION, R√âINITIALISATION, NOUVELLE FICHE (inchang√©s)
// ============================================
function previsualiser() {
    if (confirm('OK = Certificat d\'Aptitude\nAnnuler = Rapport M√©dical D√©taill√©')) imprimerCertificatAptitude();
    else genererRapportMedical();
}

function reinitialiser() {
    if (confirm('‚ö†Ô∏è R√©initialiser tous les champs ?')) location.reload();
}

function nouvelleFiche() {
    if (confirm('‚ö†Ô∏è Cr√©er une nouvelle fiche ? Les donn√©es non sauvegard√©es seront perdues.')) {
        document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(f => f.value = '');
        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
        const firstTab = document.querySelector('.tab');
        if (firstTab) firstTab.click();
    }
}

// ============================================
// 13. GESTION DU PANNEAU DE RECHERCHE
// ============================================
function afficherPanneau() {
    const panel = document.getElementById('searchHistoryPanel');
    const btn = document.getElementById('btnOpenSearch');
    if (panel) {
        panel.style.display = 'block';
        actualiserDepuisFirestore(); // üî• Lecture Firestore
    }
    if (btn) btn.style.display = 'none';
}

function cacherPanneau() {
    const panel = document.getElementById('searchHistoryPanel');
    const btn = document.getElementById('btnOpenSearch');
    if (panel) panel.style.display = 'none';
    if (btn) btn.style.display = 'block';
}

// ============================================
// 15. üî• MODIFI√â : STATISTIQUES
// ============================================
function updateStatistiquesDepuisListe(travailleurs) {
    const today = new Date(); today.setHours(0,0,0,0);
    const thisWeek = new Date(); thisWeek.setDate(thisWeek.getDate() - 7);
    const thisMonth = new Date(); thisMonth.setMonth(thisMonth.getMonth() - 1);
    let todayCount = 0, weekCount = 0, monthCount = 0;

    travailleurs.forEach(t => {
        const d = t.derniereConsultation ? new Date(t.derniereConsultation) : null;
        if (d) {
            const dc = new Date(d); dc.setHours(0,0,0,0);
            if (dc.getTime() === today.getTime()) todayCount++;
            if (d > thisWeek) weekCount++;
            if (d > thisMonth) monthCount++;
        }
    });

    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
    el('totalPatients', travailleurs.length);
    el('patientsToday', todayCount);
    el('patientsWeek', weekCount);
    el('patientsMonth', monthCount);
}

function updateStatistiques() {
    const liste = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
    updateStatistiquesDepuisListe(liste);
}

// ============================================
// 16. üî• MODIFI√â : AFFICHAGE DES PATIENTS
// ============================================
async function afficherTousPatients() {
    const container = document.getElementById('resultatsRecherche');
    if (!container) return;
    container.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:48px;">‚è≥</div><p style="margin-top:20px;color:#667eea;">Chargement depuis la base partag√©e...</p></div>';

    try {
        const travailleurs = await lireTousTravailleurs();
        if (travailleurs.length > 0) {
            afficherResultats(travailleurs);
            updateStatistiquesDepuisListe(travailleurs);
        } else {
            container.innerHTML = '<div style="text-align:center;padding:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;color:white;"><div style="font-size:80px;margin-bottom:20px;">üìÇ</div><h2>Base de donn√©es vide</h2><p>Aucun travailleur enregistr√©</p></div>';
        }
    } catch (error) {
        console.error('‚ùå Erreur:', error);
        // Fallback localStorage
        const liste = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
        if (liste.length > 0) afficherResultats(liste);
    }
}

function afficherResultats(travailleurs) {
    const container = document.getElementById('resultatsRecherche');
    if (!container) return;
    if (!travailleurs || travailleurs.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:60px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;color:white;"><div style="font-size:80px;margin-bottom:20px;">üìÇ</div><h2>Aucun r√©sultat</h2></div>';
        return;
    }
    const totalConsultations = travailleurs.reduce((t, w) => t + (w.nombreConsultations || 0), 0);
    let html = `<div style="margin-bottom:25px;padding:25px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px;">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
            <div><h3 style="margin:0 0 8px 0;font-size:24px;">üë• Base de Donn√©es Partag√©e</h3>
                <p style="margin:0;opacity:0.9;font-size:14px;">Mise √† jour : ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
                ${utilisateurConnecte ? ` | üë®‚Äç‚öïÔ∏è ${utilisateurConnecte.email}` : ''}</p></div>
            <div style="display:flex;gap:20px;margin-top:10px;">
                <div style="background:rgba(255,255,255,.2);padding:15px 25px;border-radius:10px;text-align:center;"><div style="font-size:28px;font-weight:bold;">${travailleurs.length}</div><div style="font-size:12px;opacity:.9;">Travailleurs</div></div>
                <div style="background:rgba(255,255,255,.2);padding:15px 25px;border-radius:10px;text-align:center;"><div style="font-size:28px;font-weight:bold;">${totalConsultations}</div><div style="font-size:12px;opacity:.9;">Consultations</div></div>
            </div></div></div>
        <div style="background:white;border-radius:12px;overflow:hidden;box-shadow:0 2px 15px rgba(0,0,0,.1);">
            <table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#667eea;color:white;">
                <th style="padding:16px;text-align:left;">üìã Matricule</th><th style="padding:16px;text-align:left;">üë§ Nom</th>
                <th style="padding:16px;text-align:left;">üë§ Pr√©nom</th><th style="padding:16px;text-align:left;">üè¢ Entreprise</th>
                <th style="padding:16px;text-align:center;">üìä Consult.</th><th style="padding:16px;text-align:center;">‚öôÔ∏è Actions</th>
            </tr></thead><tbody>`;

    travailleurs.forEach((t, i) => {
        const bg = i % 2 === 0 ? '#ffffff' : '#f8f9fa';
        const nb = t.nombreConsultations || 0;
        html += `<tr style="border-bottom:1px solid #e9ecef;background:${bg};transition:all .2s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${bg}'">
            <td style="padding:16px;"><span style="font-family:monospace;color:#667eea;font-weight:bold;background:#e8eaf6;padding:6px 12px;border-radius:6px;">${t.matricule||'N/A'}</span></td>
            <td style="padding:16px;font-weight:600;">${t.nom||'N/A'}</td>
            <td style="padding:16px;">${t.prenom||'N/A'}</td>
            <td style="padding:16px;"><span style="background:#f0f0f0;padding:4px 10px;border-radius:5px;font-size:13px;">${t.entreprise||'N/A'}</span></td>
            <td style="padding:16px;text-align:center;"><span style="background:${nb>0?'#667eea':'#6c757d'};color:white;padding:6px 14px;border-radius:12px;font-weight:bold;">${nb}</span></td>
            <td style="padding:16px;"><div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;">
                <button onclick="ouvrirHistoriqueDepuisListe('${t.matricule}')" style="padding:8px 14px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">üìã Historique</button>
                ${nb>0?`<button onclick="chargerDernierDossier('${t.matricule}')" style="padding:8px 14px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">üìÇ Charger</button>`:''}
                <button onclick="supprimerTravailleur('${t.matricule}')" style="padding:8px 14px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">üóëÔ∏è</button>
            </div></td></tr>`;
    });

    html += '</tbody></table></div><div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:10px;text-align:center;color:#6c757d;"><small>‚òÅÔ∏è Base partag√©e entre tous les intervenants connect√©s | Synchronisation en temps r√©el</small></div>';
    container.innerHTML = html;
}

// ============================================
// 17. üî• MODIFI√â : RECHERCHE EN TEMPS R√âEL
// ============================================
async function rechercherPatientLive() {
    const terme = document.getElementById('searchPatientInput')?.value?.toLowerCase() || '';
    if (terme.length === 0) {
        actualiserDepuisFirestore();
        return;
    }
    try {
        const tous = await lireTousTravailleurs();
        const resultats = tous.filter(t => {
            const texte = `${t.nom} ${t.prenom} ${t.entreprise} ${t.matricule} ${t.poste}`.toLowerCase();
            return texte.includes(terme);
        });
        afficherResultats(resultats);
    } catch (e) {
        // Fallback local
        const tous = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
        const resultats = tous.filter(t => JSON.stringify(t).toLowerCase().includes(terme));
        afficherResultats(resultats);
    }
}

// ============================================
// FONCTIONS NAVIGATION HISTORIQUE
// ============================================
function ouvrirHistoriqueDepuisListe(matricule) {
    const champ = document.getElementById('matricule');
    if (champ) champ.value = matricule;
    ouvrirHistorique();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function chargerDernierDossier(matricule) {
    const historique = await lireHistorique(matricule);
    if (historique.length > 0) {
        remplirFormulaire(historique[0]);
        cacherPanneau();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        alert(`‚úÖ Dernier dossier charg√© pour ${matricule}`);
    } else {
        alert('‚ùå Aucune consultation trouv√©e.');
    }
}

// üî• MODIFI√â : Supprimer via Firestore
async function supprimerTravailleur(matricule) {
    const liste = await lireTousTravailleurs();
    const t = liste.find(w => w.matricule === matricule);
    if (!t) { alert('‚ùå Travailleur introuvable.'); return; }

    if (!confirm(`‚ö†Ô∏è SUPPRESSION D√âFINITIVE\n\n${t.prenom} ${t.nom}\nMatricule: ${matricule}\n${t.nombreConsultations||0} consultation(s)\n\nCette action est IRR√âVERSIBLE !`)) return;

    setSyncStatus('sync-loading', 'üü° Suppression...');
    const ok = await supprimerDansFirestore(matricule);
    if (ok) {
        localStorage.removeItem(`historique_${matricule}`);
        let listeLocale = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
        listeLocale = listeLocale.filter(w => w.matricule !== matricule);
        localStorage.setItem('liste_travailleurs', JSON.stringify(listeLocale));
        actualiserDepuisFirestore();
        alert('‚úÖ Dossier supprim√©.');
    } else {
        alert('‚ùå Erreur lors de la suppression.');
    }
}

// ============================================
// GESTION DE L'HISTORIQUE INDIVIDUEL
// ============================================
let matriculeActuel = '';

async function ouvrirHistorique() {
    const matricule = document.getElementById('matricule')?.value?.trim();
    if (!matricule) { alert('‚ö†Ô∏è Veuillez saisir un MATRICULE.'); return; }
    matriculeActuel = matricule;

    const panel = document.getElementById('panel-historique');
    if (!panel) return;
    panel.style.display = 'block';
    document.body.style.overflow = 'hidden';
    await afficherHistorique(matricule);
}

function fermerHistorique() {
    const panel = document.getElementById('panel-historique');
    if (panel) { panel.style.display = 'none'; document.body.style.overflow = 'auto'; }
}

// üî• MODIFI√â : Lecture depuis Firestore
async function afficherHistorique(matricule) {
    const infoDiv = document.getElementById('info-travailleur');
    const contenuDiv = document.getElementById('contenu-historique');
    if (!contenuDiv) return;

    contenuDiv.innerHTML = '<p style="text-align:center;padding:40px;color:#6c757d;"><span style="font-size:50px;display:block;margin-bottom:15px;">‚è≥</span>Chargement depuis la base partag√©e...</p>';

    const historique = await lireHistorique(matricule);

    if (historique.length === 0) {
        if (infoDiv) infoDiv.innerHTML = `Matricule: <strong>${matricule}</strong> - Aucune consultation`;
        contenuDiv.innerHTML = '<div style="text-align:center;padding:60px;color:#6c757d;"><div style="font-size:80px;margin-bottom:20px;">üìÇ</div><h3>Aucune consultation trouv√©e</h3></div>';
        return;
    }

    const derniere = historique[0];
    const ident = derniere.identification || {};
    const nomComplet = `${ident.prenom || ''} ${ident.nom || ''}`.trim();
    if (infoDiv) infoDiv.innerHTML = `üë§ <strong>${nomComplet}</strong> | üî¢ Matricule: <strong>${matricule}</strong> | üìä <strong>${historique.length}</strong> consultation(s)`;

    let html = '';
    historique.forEach((consult, index) => {
        const dateConsult = new Date(consult.dateSauvegarde || consult.dateConsultation || Date.now());
        const prof = consult.professionnel || {};
        const concl = consult.conclusion || {};
        const aptitude = concl.aptitude || 'Non renseign√©';
        let couleur = '#28a745', bg = '#d4edda';
        if (aptitude.includes('inapte')) { couleur = '#dc3545'; bg = '#f8d7da'; }
        else if (aptitude.includes('avec') || aptitude.includes('restriction')) { couleur = '#ffc107'; bg = '#fff3cd'; }

        html += `<div style="background:white;border:2px solid #dee2e6;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:15px;border-bottom:2px solid #e9ecef;">
                <div><h3 style="margin:0;color:#667eea;font-size:18px;">üìÖ Consultation #${historique.length - index}</h3>
                    <p style="margin:5px 0 0;color:#6c757d;font-size:13px;">${dateConsult.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
                    ${consult.enregistrePar ? ` | par ${consult.enregistrePar}` : ''}</p></div>
                <div style="display:flex;flex-direction:column;gap:5px;">
                    <button onclick="chargerConsultationParIndex('${matricule}',${index})" style="padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">üìÇ Charger</button>
                    <button onclick="supprimerConsultation('${matricule}','${consult.id}')" style="padding:8px 16px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;">üóëÔ∏è Supprimer</button>
                </div></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px;">
                <div><strong style="color:#495057;font-size:13px;">üè¢ Entreprise:</strong><br>${prof.entreprise||'N/R'}</div>
                <div><strong style="color:#495057;font-size:13px;">üíº Poste:</strong><br>${prof.poste||'N/R'}</div>
                <div><strong style="color:#495057;font-size:13px;">üìã Type visite:</strong><br>${prof.typeVisite||'N/R'}</div></div>
            <div style="background:${bg};border-left:5px solid ${couleur};padding:15px;border-radius:8px;">
                <strong style="color:${couleur};font-size:14px;">‚úÖ APTITUDE:</strong><br>
                <span style="font-size:18px;font-weight:bold;color:${couleur};">${aptitude}</span>
                ${concl.restrictions ? `<div style="margin-top:10px;font-size:13px;"><strong>üö´ Restrictions:</strong> ${concl.restrictions}</div>` : ''}</div>
            ${consult.medecin ? `<div style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:6px;font-size:13px;"><strong>üë®‚Äç‚öïÔ∏è M√©decin:</strong> Dr. ${consult.medecin}</div>` : ''}
        </div>`;
    });
    contenuDiv.innerHTML = html;
}

// Charger une consultation par index
async function chargerConsultationParIndex(matricule, index) {
    const historique = await lireHistorique(matricule);
    if (!historique[index]) { alert('‚ùå Consultation introuvable.'); return; }
    fermerHistorique();
    remplirFormulaire(historique[index]);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    alert('‚úÖ Consultation charg√©e !');
}

// üî• MODIFI√â : Supprimer via Firestore
async function supprimerConsultation(matricule, consultationId) {
    if (!confirm('‚ö†Ô∏è Supprimer cette consultation ?')) return;
    setSyncStatus('sync-loading', 'üü° Suppression...');
    const ok = await supprimerConsultationFirestore(matricule, consultationId);
    if (ok) {
        afficherHistorique(matricule);
        setSyncStatus('sync-ok', 'üü¢ Synchronis√©');
    } else {
        alert('‚ùå Erreur lors de la suppression.');
        setSyncStatus('sync-error', 'üî¥ Erreur');
    }
}

// ============================================
// REMPLIR LE FORMULAIRE (inchang√©)
// ============================================
function remplirFormulaire(consult) {
    const setVal = (id, val) => { const e = document.getElementById(id); if (e) e.value = val || ''; };
    const ident = consult.identification || {};
    setVal('nom', ident.nom); setVal('prenom', ident.prenom); setVal('date-naissance', ident.dateNaissance);
    setVal('age', ident.age); setVal('genre', ident.genre); setVal('matricule', ident.matricule);
    setVal('telephone', ident.telephone); setVal('email', ident.email); setVal('adresse', ident.adresse);

    const prof = consult.professionnel || {};
    setVal('entreprise', prof.entreprise); setVal('poste', prof.poste); setVal('departement', prof.departement);
    setVal('date-embauche', prof.dateEmbauche); setVal('type-contrat', prof.typeContrat);
    setVal('horaire-travail', prof.horaireTravail); setVal('type-visite', prof.typeVisite);

    const ant = consult.antecedents || {};
    setVal('autres-antecedents', ant.medicaux); setVal('chirurgie', ant.chirurgicaux);
    setVal('accident-travail', ant.accidentTravail); setVal('maladie-pro', ant.maladiePro);
    setVal('allergies', ant.allergies); setVal('tabac', ant.tabac); setVal('nb-cigarettes', ant.nbCigarettes);
    setVal('alcool', ant.alcool); setVal('activite-physique', ant.activitePhysique); setVal('medicaments', ant.medicaments);

    const c = consult.constantes || {};
    setVal('poids', c.poids); setVal('taille', c.taille); setVal('ta-systolique', c.taSystolique);
    setVal('ta-diastolique', c.taDiastolique); setVal('pouls', c.pouls);
    setVal('frequence-resp', c.frequenceResp); setVal('temperature', c.temperature);
    setVal('saturation', c.saturation); setVal('etat-general', c.etatGeneral);
    setVal('observations-generales', c.observations);

    const ex = consult.examensPhysiques || {};
    setVal('examen-cardio', ex.cardio); setVal('examen-pulm', ex.pulm); setVal('examen-abdo', ex.abdo);
    setVal('examen-neuro', ex.neuro); setVal('examen-osteo', ex.osteo); setVal('examen-dermato', ex.dermato);
    setVal('examen-orl', ex.orl); setVal('examen-ophtalmo', ex.ophtalmo);

    const bio = consult.biologie || {};
    setVal('date-bilan', bio.dateBilan); setVal('glycemie', bio.glycemie); setVal('hba1c', bio.hba1c);
    setVal('cholesterol-total', bio.cholesterolTotal); setVal('hdl', bio.hdl); setVal('ldl', bio.ldl);
    setVal('triglycerides', bio.triglycerides); setVal('creatinine', bio.creatinine);
    setVal('acide-urique', bio.acideUrique); setVal('asat', bio.asat); setVal('alat', bio.alat);
    setVal('hemoglobine', bio.hemoglobine); setVal('hematocrite', bio.hematocrite);
    setVal('leucocytes', bio.leucocytes); setVal('plaquettes', bio.plaquettes);

    const img = consult.imagerie || {};
    setVal('radio-thorax', img.radioThorax); setVal('ecg', img.ecg); setVal('echographie', img.echographie);

    const fonc = consult.examensFonctionnels || {};
    setVal('audiometrie', fonc.audiometrie); setVal('spirometrie', fonc.spirometrie);
    setVal('vision-od', fonc.visionOD); setVal('vision-og', fonc.visionOG); setVal('vision-binoculaire', fonc.visionBinoculaire);
    setVal('autres-examens', fonc.autresExamens);

    const concl = consult.conclusion || {};
    setVal('aptitude', concl.aptitude); setVal('restrictions', concl.restrictions);
    setVal('duree-inaptitude', concl.dureeInaptitude); setVal('recommandations', concl.recommandations);
    setVal('orientations', concl.orientations); setVal('examens-complementaires', concl.examensComplementaires);
    setVal('prochaine-visite', concl.prochaineVisite);
    setVal('date-examen', consult.dateConsultation);

    const cab = consult.cabinet || {};
    setVal('nom-cabinet', cab.nomCabinet); setVal('medecin', consult.medecin || '');
    setVal('numero-ordre', cab.numeroOrdre); setVal('lieu-examen', cab.lieuExamen);

    // Recalculer IMC et √¢ge
    calculerIMC(); calculerAge(); gererAptitude();
}

// ============================================
// EXPORTS (fonctionnent identiquement, lisent Firestore)
// ============================================
async function exporterCSVComplet() {
    const travailleurs = await lireTousTravailleurs();
    if (travailleurs.length === 0) { alert('Aucune donn√©e √† exporter'); return; }
    let csv = '\uFEFFMatricule,Nom,Pr√©nom,Entreprise,Poste,Nb Consultations,Derni√®re Aptitude\n';
    travailleurs.forEach(t => {
        csv += `"${t.matricule||''}","${t.nom||''}","${t.prenom||''}","${t.entreprise||''}","${t.poste||''}","${t.nombreConsultations||0}","${t.derniereAptitude||''}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Export_Travailleurs_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function exporterToutesConsultationsPDFAvecFiltres() {
    alert('üìÑ Export PDF en cours...\nCette fonction utilise les donn√©es Firestore mises en cache localement.');
    // Utilise le cache localStorage qui est synchronis√© avec Firestore
    exporterToutesConsultationsPDF({});
}

function exporterToutesConsultationsPDF(filtres) {
    const { jsPDF } = window.jspdf;
    if (!jsPDF) { alert('‚ùå jsPDF non charg√©e'); return; }
    let consultations = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('historique_')) {
            const hist = JSON.parse(localStorage.getItem(key) || '[]');
            hist.forEach(c => consultations.push(c));
        }
    }
    if (consultations.length === 0) { alert('‚ùå Aucune consultation.'); return; }
    consultations.sort((a, b) => new Date(b.dateSauvegarde||0) - new Date(a.dateSauvegarde||0));

    const doc = new jsPDF();
    let y = 20;
    doc.setFontSize(18); doc.setFont(undefined, 'bold');
    doc.text('RAPPORT DES CONSULTATIONS', 105, y, { align: 'center' }); y += 10;
    doc.setFontSize(10); doc.setFont(undefined, 'normal');
    doc.text(`Export√© le ${new Date().toLocaleDateString('fr-FR')} | ${consultations.length} consultations`, 105, y, { align: 'center' }); y += 15;

    consultations.forEach((c, idx) => {
        if (y > 260) { doc.addPage(); y = 20; }
        const ident = c.identification || {};
        const concl = c.conclusion || {};
        doc.setDrawColor(102, 126, 234); doc.line(20, y, 190, y); y += 8;
        doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.setTextColor(102, 126, 234);
        doc.text(`#${idx+1} - ${ident.prenom||''} ${ident.nom||''} (${ident.matricule||'N/A'})`, 20, y); y += 6;
        doc.setTextColor(0,0,0); doc.setFontSize(9); doc.setFont(undefined, 'normal');
        doc.text(`Date: ${c.dateConsultation||'N/A'} | Entreprise: ${c.professionnel?.entreprise||'N/A'} | Aptitude: ${concl.aptitude||'N/A'}`, 20, y); y += 10;
    });

    doc.save(`Rapport_Consultations_${new Date().toISOString().split('T')[0]}.pdf`);
    alert(`‚úÖ PDF export√© (${consultations.length} consultations)`);
}

function exporterStatistiquesPDF() {
    alert('üìä Export des statistiques...');
    // Simplifi√© - utilise le cache local
    const { jsPDF } = window.jspdf;
    if (!jsPDF) { alert('‚ùå jsPDF non charg√©e'); return; }
    const liste = JSON.parse(localStorage.getItem('liste_travailleurs') || '[]');
    if (liste.length === 0) { alert('‚ùå Aucune donn√©e.'); return; }

    const doc = new jsPDF();
    doc.setFontSize(18); doc.setFont(undefined, 'bold');
    doc.text('STATISTIQUES GLOBALES', 105, 20, { align: 'center' });
    doc.setFontSize(10); doc.setFont(undefined, 'normal');
    doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 105, 28, { align: 'center' });
    let y = 45;
    doc.text(`Total travailleurs: ${liste.length}`, 25, y); y += 7;
    const entreprises = new Set(liste.map(t => t.entreprise).filter(Boolean));
    doc.text(`Entreprises: ${entreprises.size}`, 25, y); y += 7;
    const totalConsult = liste.reduce((s, t) => s + (t.nombreConsultations||0), 0);
    doc.text(`Total consultations: ${totalConsult}`, 25, y); y += 15;

    doc.setFont(undefined, 'bold'); doc.text('Par entreprise:', 25, y); y += 7;
    doc.setFont(undefined, 'normal');
    entreprises.forEach(e => {
        const nb = liste.filter(t => t.entreprise === e).length;
        if (y > 270) { doc.addPage(); y = 20; }
        doc.text(`  ${e}: ${nb} travailleur(s)`, 25, y); y += 6;
    });

    doc.save(`Statistiques_${new Date().toISOString().split('T')[0]}.pdf`);
}

function exporterConsultationsFiltrees() {
    const dateDebut = prompt('üìÖ Date de d√©but (JJ/MM/AAAA):');
    const dateFin = prompt('üìÖ Date de fin (JJ/MM/AAAA):');
    if (!dateDebut || !dateFin) return;
    alert('üìÖ Export par p√©riode en cours...');
    exporterToutesConsultationsPDF({ dateDebut, dateFin });
}

function exporterPDFProtege() {
    const mdp = prompt('üîí Mot de passe (min 6 car.):');
    if (!mdp || mdp.length < 6) { alert('‚ùå Mot de passe trop court.'); return; }
    alert('üîí Export prot√©g√©... Le PDF sera g√©n√©r√© normalement.\n(La protection par mot de passe n√©cessite une librairie suppl√©mentaire.)');
    exporterToutesConsultationsPDF({});
}

// ============================================
// IMPRIMER HISTORIQUE (inchang√©, lit depuis variable)
// ============================================
async function imprimerHistorique() {
    if (!matriculeActuel) { alert('‚ùå Aucun matricule.'); return; }
    const historique = await lireHistorique(matriculeActuel);
    if (historique.length === 0) { alert('‚ùå Aucune consultation.'); return; }
    const ident = historique[0].identification || {};
    const nomComplet = `${ident.prenom || ''} ${ident.nom || ''}`.trim();

    const w = window.open('', '_blank', 'width=800,height=600');
    if (!w) { alert('‚ùå Pop-ups bloqu√©es.'); return; }
    let htmlContenu = '';
    historique.forEach((c, i) => {
        const d = new Date(c.dateSauvegarde || c.dateConsultation || Date.now());
        const prof = c.professionnel || {};
        const concl = c.conclusion || {};
        const apt = concl.aptitude || 'N/R';
        let col = '#28a745', bg = '#d4edda';
        if (apt.includes('inapte')) { col = '#dc3545'; bg = '#f8d7da'; }
        else if (apt.includes('avec')) { col = '#ffc107'; bg = '#fff3cd'; }
        htmlContenu += `<div style="background:white;border:2px solid #dee2e6;border-radius:10px;padding:20px;margin-bottom:20px;page-break-inside:avoid;">
            <h3 style="color:#667eea;">üìÖ Consultation #${historique.length - i}</h3>
            <p style="color:#6c757d;">${d.toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>
            <p><strong>üè¢</strong> ${prof.entreprise||'N/R'} | <strong>üíº</strong> ${prof.poste||'N/R'}</p>
            <div style="background:${bg};border-left:5px solid ${col};padding:15px;border-radius:8px;">
                <strong style="color:${col};">APTITUDE: ${apt}</strong></div>
            ${c.medecin ? `<p style="margin-top:10px;"><strong>üë®‚Äç‚öïÔ∏è</strong> Dr. ${c.medecin}</p>` : ''}
        </div>`;
    });
    w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Historique - ${nomComplet}</title>
        <style>body{font-family:Arial,sans-serif;padding:20px;}.header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:10px;margin-bottom:30px;}</style></head>
        <body><div class="header"><h1>üìã HISTORIQUE M√âDICAL</h1><p>üë§ ${nomComplet} | üî¢ ${matriculeActuel} | üìä ${historique.length} consultation(s)</p></div>
        ${htmlContenu}<script>window.onload=function(){window.print();}<\/script></body></html>`);
    w.document.close();
}

// ============================================
// RAPPORT M√âDICAL COMPLET (inchang√©, lit depuis le DOM)
// ============================================
function genererRapportMedical() {
    const getData = (id) => document.getElementById(id)?.value || 'Non renseign√©';
    const getSelectText = (id) => { const s = document.getElementById(id); return s?.options[s.selectedIndex]?.text || 'Non renseign√©'; };

    const nom = getData('nom').toUpperCase(), prenom = getData('prenom').toUpperCase();
    const nomCabinet = getData('nom-cabinet'), medecin = getData('medecin');
    const aptitude = getSelectText('aptitude');

    const pw = window.open('', '', 'width=900,height=1200');
    pw.document.write(`<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Rapport - ${nom} ${prenom}</title>
    <style>@page{size:A4;margin:15mm}body{font-family:Arial,sans-serif;font-size:10px;line-height:1.5}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;text-align:center;border-radius:10px;margin-bottom:20px}.header h1{margin:0;font-size:22px}
    .confidential-mark{background:#dc3545;color:white;padding:8px;text-align:center;font-weight:bold;margin-bottom:15px;border-radius:5px}
    .section{margin-bottom:15px;padding:12px;border:1px solid #ddd;border-radius:8px;background:#f8f9fa;page-break-inside:avoid}
    .section-title{font-weight:bold;font-size:12px;color:#667eea;margin-bottom:10px;border-bottom:2px solid #667eea;padding-bottom:5px}
    .row{display:flex;margin-bottom:5px}.label{font-weight:bold;width:200px;color:#555}.value{flex:1}
    .two-columns{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .aptitude-box{background:#e8f4ff;padding:15px;border:3px solid #667eea;border-radius:10px;text-align:center;margin:20px 0}
    .aptitude-box .decision{font-size:16px;font-weight:bold;color:#667eea;margin:8px 0}
    .signature-box{display:flex;justify-content:space-between;margin-top:20px;padding-top:15px;border-top:2px dashed #999}
    .signature{width:45%;text-align:center}.signature-line{border-top:1px solid #333;margin-top:40px;padding-top:5px}
    .stamp-area{border:2px dashed #999;padding:30px;text-align:center;color:#999;width:45%}
    .footer-info{text-align:center;margin-top:15px;font-size:8px;color:#999}</style></head>
    <body>
    <div class="header"><h1>üè• ${nomCabinet}</h1><p>RAPPORT M√âDICAL CONFIDENTIEL</p></div>
    <div class="confidential-mark">üîí DOCUMENT M√âDICAL CONFIDENTIEL</div>
    <div class="two-columns">
        <div class="section"><div class="section-title">üë§ IDENTIFICATION</div>
            <div class="row"><span class="label">Nom:</span><span class="value"><strong>${nom}</strong></span></div>
            <div class="row"><span class="label">Pr√©nom:</span><span class="value"><strong>${prenom}</strong></span></div>
            <div class="row"><span class="label">Naissance:</span><span class="value">${getData('date-naissance')}</span></div>
            <div class="row"><span class="label">√Çge:</span><span class="value">${getData('age')}</span></div>
            <div class="row"><span class="label">Matricule:</span><span class="value">${getData('matricule')}</span></div></div>
        <div class="section"><div class="section-title">üè¢ PROFESSIONNEL</div>
            <div class="row"><span class="label">Entreprise:</span><span class="value"><strong>${getData('entreprise')}</strong></span></div>
            <div class="row"><span class="label">Poste:</span><span class="value">${getData('poste')}</span></div>
            <div class="row"><span class="label">Embauche:</span><span class="value">${getData('date-embauche')}</span></div>
            <div class="row"><span class="label">Anciennet√©:</span><span class="value">${document.getElementById('anciennete')?.textContent||''}</span></div>
            <div class="row"><span class="label">Type visite:</span><span class="value">${getSelectText('type-visite')}</span></div></div>
    </div>
    <div class="section"><div class="section-title">ü©∫ CONSTANTES</div>
        <div class="two-columns"><div>
            <div class="row"><span class="label">Poids:</span><span class="value">${getData('poids')} kg</span></div>
            <div class="row"><span class="label">Taille:</span><span class="value">${getData('taille')} cm</span></div>
            <div class="row"><span class="label">IMC:</span><span class="value">${getData('imc')} (${getData('interpretation-imc')})</span></div>
            <div class="row"><span class="label">TA:</span><span class="value">${getData('ta-systolique')}/${getData('ta-diastolique')} mmHg</span></div>
        </div><div>
            <div class="row"><span class="label">Pouls:</span><span class="value">${getData('pouls')} /min</span></div>
            <div class="row"><span class="label">SpO2:</span><span class="value">${getData('saturation')} %</span></div>
            <div class="row"><span class="label">Temp.:</span><span class="value">${getData('temperature')} ¬∞C</span></div>
        </div></div></div>
    <div class="aptitude-box"><div style="font-size:14px;font-weight:bold;">‚úÖ CONCLUSION</div><div class="decision">${aptitude}</div>
        ${getData('restrictions')!=='Non renseign√©'?`<div><strong>Restrictions:</strong> ${getData('restrictions')}</div>`:''}</div>
    ${getData('recommandations')!=='Non renseign√©'?`<div class="section"><div class="section-title">üìã RECOMMANDATIONS</div><div>${getData('recommandations')}</div></div>`:''}
    <div class="signature-box"><div class="signature"><strong>Le M√©decin du Travail</strong><div style="margin-top:10px;">Dr. ${medecin}</div><div class="signature-line">Signature et cachet</div></div><div class="stamp-area">Cachet</div></div>
    <div class="footer-info">APSUMEDTRAV - ${new Date().toLocaleDateString('fr-FR')} ${new Date().toLocaleTimeString('fr-FR')}</div>
    </body></html>`);
    pw.document.close();
    setTimeout(() => pw.print(), 500);
}

// ============================================
// MENUS D√âROULANTS (inchang√©s)
// ============================================
function toggleMenuExports() {
    const m = document.getElementById('menuExports');
    if (m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
}
function toggleMenuDocuments() {
    const m = document.getElementById('menuDocuments');
    if (m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', function(event) {
    const me = document.getElementById('menuExports');
    const md = document.getElementById('menuDocuments');
    if (!event.target.closest('#menuExports') && !event.target.closest('button[onclick*="toggleMenuExports"]') && me) me.style.display = 'none';
    if (!event.target.closest('#menuDocuments') && !event.target.closest('button[onclick*="toggleMenuDocuments"]') && md) md.style.display = 'none';
});

// ============================================
// UTILITAIRES
// ============================================
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    try { return new Date(dateStr).toLocaleDateString('fr-FR'); }
    catch (e) { return dateStr; }
}

// ============================================
// INITIALISATION AU CHARGEMENT
// ============================================
window.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ APSUMEDTRAV v3.0 - Multi-Utilisateurs charg√©');

    // Formatage dates
    ['date-naissance', 'date-embauche', 'date-examen', 'prochaine-visite', 'date-bilan'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.addEventListener('input', function() { formaterDate(this); });
    });

    // Enter sur le login
    document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') connexion();
    });
});
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë       EXPORT RAPPORT INDIVIDUEL COMPLET ‚Üí EXCEL (.xlsx)         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

function exporterRapportExcel() {
    // V√©rifier que SheetJS est charg√©
    if (typeof XLSX === 'undefined') {
        alert('‚è≥ Chargement de la biblioth√®que Excel...');
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        s.onload = () => setTimeout(exporterRapportExcel, 500);
        document.head.appendChild(s);
        return;
    }

    // R√©cup√©rer infos patient
    const nom = document.getElementById('nom')?.value || '';
    const prenom = document.getElementById('prenom')?.value || '';
    const matricule = document.getElementById('matricule')?.value || '';

    if (!nom && !prenom && !matricule) {
        alert('‚ö†Ô∏è Aucun patient charg√© !\n\n' +
              '1. Ouvrez l\'historique\n' +
              '2. Cliquez "üìÇ Charger" sur une consultation\n' +
              '3. Puis cliquez "üìó Excel Individuel"');
        return;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLLECTER TOUTES LES DONN√âES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const rows = [];

    // EN-T√äTE DU RAPPORT
    rows.push(['RAPPORT DE CONSULTATION M√âDICALE - FICHE D\'APTITUDE']);
    rows.push(['']);
    rows.push(['Patient', prenom + ' ' + nom]);
    rows.push(['Matricule', matricule]);
    rows.push(['Date d\'export', new Date().toLocaleDateString('fr-FR', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    })]);
    rows.push(['']);

    // PARCOURIR LE DOM EN ORDRE
    const mainForm = document.querySelector('form') 
                  || document.querySelector('.main-content') 
                  || document.querySelector('[id*="consultation"]')
                  || document.body;

    const allElements = mainForm.querySelectorAll(
        'h2, h3, h4, h5, input, select, textarea'
    );

    const seen = new Set();
    let currentSection = '';

    allElements.forEach(el => {
        // Ignorer login, modals, historique
        if (el.closest('#loginScreen, .login-container, .modal-overlay, .history-modal, #searchHistoryPanel')) return;
        if (el.closest('[id*="login"], [id*="auth"]')) return;

        // ‚îÄ‚îÄ TITRES = S√©parateurs de section ‚îÄ‚îÄ
        if (['H2', 'H3', 'H4', 'H5'].includes(el.tagName)) {
            const text = el.textContent.replace(/[üìãüè•üíäüî¨üíâ‚ö†Ô∏èü©∫üìä‚úÖ‚ùåüîçüë§üìùü´Åü¶¥üëÅÔ∏èüëÇüß†ü´Äü©∏üíÄü¶∑üß™]/gu, '').trim();
            if (text && text.length > 2 && text !== currentSection) {
                currentSection = text;
                rows.push(['']);
                rows.push(['‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨ ' + text.toUpperCase() + ' ‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨', '']);
                rows.push(['Champ', 'Valeur']);
            }
            return;
        }

        // ‚îÄ‚îÄ CHAMPS DE FORMULAIRE ‚îÄ‚îÄ
        if (['hidden', 'button', 'submit', 'reset', 'password', 'file'].includes(el.type)) return;
        if (el.type === 'radio' && !el.checked) return;

        // √âviter doublons
        const key = el.id || el.name || '';
        if (key && seen.has(key)) return;
        if (key) seen.add(key);

        // ‚îÄ‚îÄ Trouver le LABEL ‚îÄ‚îÄ
        let label = '';

        // 1. Label avec for="id"
        if (el.id) {
            const lbl = document.querySelector('label[for="' + el.id + '"]');
            if (lbl) label = lbl.textContent.replace(/\*/g, '').trim();
        }

        // 2. Label parent
        if (!label) {
            const parentLabel = el.closest('label');
            if (parentLabel) {
                const clone = parentLabel.cloneNode(true);
                clone.querySelectorAll('input, select, textarea').forEach(c => c.remove());
                label = clone.textContent.replace(/\*/g, '').trim();
            }
        }

        // 3. √âl√©ment fr√®re pr√©c√©dent
        if (!label) {
            const prev = el.previousElementSibling;
            if (prev && ['LABEL', 'SPAN', 'STRONG', 'B'].includes(prev.tagName)) {
                label = prev.textContent.replace(/\*/g, '').trim();
            }
        }

        // 4. Groupe parent
        if (!label) {
            const group = el.closest('.form-group, .field-group, .input-group, .form-field, div[class*="group"]');
            if (group) {
                const lbl = group.querySelector('label, .label, strong');
                if (lbl && !lbl.querySelector('input, select')) {
                    label = lbl.textContent.replace(/\*/g, '').trim();
                }
            }
        }

        // 5. Fallback
        if (!label) label = el.placeholder || el.name || el.id || '';
        if (!label || label.length < 2) return;

        // Nettoyer le label
        label = label.replace(/[\n\r\t]+/g, ' ').replace(/\s{2,}/g, ' ').trim();

        // ‚îÄ‚îÄ Trouver la VALEUR ‚îÄ‚îÄ
        let value = '';

        if (el.type === 'checkbox') {
            value = el.checked ? '‚úì Oui' : '‚úó Non';
        } else if (el.type === 'radio') {
            const radioLabel = el.id ? document.querySelector('label[for="' + el.id + '"]') : null;
            value = radioLabel ? radioLabel.textContent.trim() : el.value;
        } else if (el.tagName === 'SELECT') {
            const opt = el.options[el.selectedIndex];
            value = opt ? opt.text.trim() : '';
            if (!value || value.startsWith('S√©lect') || value.startsWith('-- ') || value.startsWith('Choisir')) {
                value = '‚Äî';
            }
        } else if (el.type === 'date' && el.value) {
            const d = new Date(el.value);
            value = d.toLocaleDateString('fr-FR');
        } else {
            value = el.value || '‚Äî';
        }

        rows.push([label, value]);
    });

    // PIED DE RAPPORT
    rows.push(['']);
    rows.push(['‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨', '']);
    rows.push(['Rapport g√©n√©r√© par', 'APSUMEDTRAV']);
    rows.push(['Date et heure', new Date().toLocaleString('fr-FR')]);
    rows.push(['Signature m√©decin', '________________________']);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CR√âER LE FICHIER EXCEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ws = XLSX.utils.aoa_to_sheet(rows);

    // Largeur des colonnes
    ws['!cols'] = [
        { wch: 45 },   // Colonne A - Labels
        { wch: 55 }    // Colonne B - Valeurs
    ];

    // Style de la premi√®re ligne (titre)
    // Note: le formatage avanc√© n√©cessite xlsx-style, 
    // mais la structure reste claire

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Rapport Consultation');

    // Nom du fichier
    const dateStr = new Date().toISOString().split('T')[0];
    const nomFichier = ('Rapport_' + nom + '_' + prenom + '_' + matricule + '_' + dateStr + '.xlsx')
        .replace(/\s+/g, '_')
        .replace(/_{2,}/g, '_');

    // T√©l√©charger
    XLSX.writeFile(wb, nomFichier);

    alert('‚úÖ Rapport Excel export√© avec succ√®s !\n\nüìó ' + nomFichier);
}       
</script>
</body>

